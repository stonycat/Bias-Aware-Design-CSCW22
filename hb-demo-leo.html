<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">

  <title>Booking Hotel</title>

  <!-- Bootstrap4 core CSS -->
  <link href="css/bootstrap.min.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>

  <!-- Bootstrap4 core JavaScript
  ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
    integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
    crossorigin="anonymous"></script>
  <script>window.jQuery || document.write('<script src="js/jquery-slim.min.js"><\/script>')</script>
  <script src="js/popper.min.js"></script>
  <script src="js/holder.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/bootstrap-slider.js"></script>
  <script src="https://kit.fontawesome.com/4421af3ebc.js" crossorigin="anonymous"></script>
  <script type="text/javascript" src="https://unpkg.com/parse/dist/parse.min.js"></script>
  <script type="text/javascript" src="https://unpkg.com/lodash@4.17.20/lodash.min.js"></script>

  <script src="js/parse.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/RubaXa/Sortable/Sortable.min.js"></script>

</head>

<body>
  <!-- Empty element, will be filled in the content by the code below -->
  <div id="handlebars-rendering-target"></div>

  <script id="entry-template" type="text/x-handlebars-template">
    {{!-- Template, mixing html with handlebars syntax --}}
    <div class="container">
      <h1>{{title}}</h1>
      <div class="body">
        <button type="button" class="btn btn-success" data-toggle="modal" data-target="#modal-picktop">
          Picked Top 3
        </button>
        <div class="modal fade" id="modal-picktop" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="modalLabel">Rearrange the hotels</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body" id="picktop-modal-body">
                
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button id="modal-picktop-save" type="button" class="btn btn-primary" onclick="recordOrder()">Save changes</button>
              </div>
            </div>
          </div>
        </div>

        <button type="button" class="btn btn-primary" onclick="sortHotels(['rating'], ['asc'])">
          SortByRating
        </button>
        <button type="button" class="btn btn-primary" onclick="sortHotels(['name'], ['asc'])">
          SortByName
        </button>
        <div id="body-hotel-list">
          {{> hotellist hotels=hotels}}
        </div>
      </div>
    </div>
  </script>

  <script id="hotellist-template" type="text/x-handlebars-template">
    {{#each hotels as |hotel| }}
      <h2 id="hotel-{{hotel.index}}">{{addone hotel.index}} {{hotel.name}}</h2>
      {{#if hotel.checked}}
        <input class="form-check-input" type="checkbox" value="" id="checkbox-hotel-{{hotel.index}}" onchange="pickHotel({{hotel.index}})" checked>
      {{else}}
        <input class="form-check-input" type="checkbox" value="" id="checkbox-hotel-{{hotel.index}}" onchange="pickHotel({{hotel.index}})">
      {{/if}}
      <p>{{hotel.description}}</p>
      <h5>Reviews:</h5>
      {{#each hotel.reviews as |review|}}
        <p>{{review.content}} {{review.rating}}</p>
      {{/each}}
      {{> reviewmodal hotel=hotel}}
      <div id="vis-{{hotel.index}}"></div>
    {{/each}}
  </script>

  <script id="modal-template" type="text/x-handlebars-template">
    {{!-- Modal template, using partial --}}
    <!-- Button trigger modal -->
    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#modal-{{hotel.index}}">
      Launch demo modal
    </button>

    <!-- Modal -->
    <div class="modal fade" id="modal-{{hotel.index}}" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalLabel">Reviews of Hotel #{{addone hotel.index}}</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div id="modal-vis-{{hotel.index}}"></div>
            <button type="button" class="btn btn-primary" onclick="filterReviews({{hotel.index}}, {rating: 5})">Fliter</button>
            <div id="modal-reviews-{{hotel.index}}">
              {{> reviewlist reviews=hotel.reviews}}
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" onclick="recordResult()">Save changes</button>
          </div>
        </div>
      </div>
    </div>
  </script>

  <script id="reviewlist-template" type="text/x-handlebars-template">
    {{#each reviews as |review|}}
      <p>{{review.content}} {{review.rating}}</p>
    {{/each}}
  </script>

  <script>
    // Data to be rendered
    
    var context = {
      title: 'Which hotel do you like?',
    hotels: [{ 
        name: 'Hotel A',
        description: 'Hotel A is a 5-star luxury hotel.',
        rating: 3.5,
        reviews: [{
          content: "It's good!",
          rating: 5
        },
        {
          content: "I don't like it!",
          rating: 1
        },
        {
          content: "OK 5 points!",
          rating: 5
        }
        ],
        data: [
          { a: 'A', b: 28 },
          { a: 'B', b: 55 },
          { a: 'C', b: 43 },
          { a: 'D', b: 91 },
          { a: 'E', b: 81 },
          { a: 'F', b: 53 },
          { a: 'G', b: 19 },
          { a: 'H', b: 87 },
          { a: 'I', b: 52 }
        ]
      }, {
        name: 'Hotel B',
        description: 'Hotel B is a 3-star economy hotel.',
        rating: 3,
        reviews: [{
          content: "It's ok!",
          rating: 4
        },
        {
          content: "Price is cheap, but not comfortable!",
          rating: 2
        }
        ],
        data: [
          { a: 'A', b: 91 },
          { a: 'B', b: 63 },
          { a: 'C', b: 101 },
          { a: 'D', b: 38 },
          { a: 'E', b: 53 },
          { a: 'F', b: 65 },
          { a: 'G', b: 97 },
          { a: 'H', b: 29 },
          { a: 'I', b: 62 }
        ]
      }, {
        name: 'Hotel F',
        description: 'Hotel B is a 3-star economy hotel.',
        rating: 4,
        reviews: [{
          content: "It's ok!",
          rating: 4
        },
        {
          content: "Price is cheap, but not comfortable!",
          rating: 2
        }
        ],
        data: [
          { a: 'A', b: 91 },
          { a: 'B', b: 63 },
          { a: 'C', b: 101 },
          { a: 'D', b: 38 },
          { a: 'E', b: 53 },
          { a: 'F', b: 65 },
          { a: 'G', b: 97 },
          { a: 'H', b: 29 },
          { a: 'I', b: 62 }
        ]
      }, {
        name: 'Hotel C',
        description: 'Hotel B is a 3-star economy hotel.',
        rating: 5,
        reviews: [{
          content: "It's ok!",
          rating: 4
        },
        {
          content: "Price is cheap, but not comfortable!",
          rating: 2
        }
        ],
        data: [
          { a: 'A', b: 91 },
          { a: 'B', b: 63 },
          { a: 'C', b: 101 },
          { a: 'D', b: 38 },
          { a: 'E', b: 53 },
          { a: 'F', b: 65 },
          { a: 'G', b: 97 },
          { a: 'H', b: 29 },
          { a: 'I', b: 62 }
        ]
      }, {
        name: 'Hotel D',
        description: 'Hotel B is a 3-star economy hotel.',
        rating: 2,
        reviews: [{
          content: "It's ok!",
          rating: 4
        },
        {
          content: "Price is cheap, but not comfortable!",
          rating: 2
        }
        ],
        data: [
          { a: 'A', b: 91 },
          { a: 'B', b: 63 },
          { a: 'C', b: 101 },
          { a: 'D', b: 38 },
          { a: 'E', b: 53 },
          { a: 'F', b: 65 },
          { a: 'G', b: 97 },
          { a: 'H', b: 29 },
          { a: 'I', b: 62 }
        ]
      }, {
        name: 'Hotel E',
        description: 'Hotel B is a 3-star economy hotel.',
        rating: 1,
        reviews: [{
          content: "It's ok!",
          rating: 4
        },
        {
          content: "Price is cheap, but not comfortable!",
          rating: 2
        }
        ],
        data: [
          { a: 'A', b: 91 },
          { a: 'B', b: 63 },
          { a: 'C', b: 101 },
          { a: 'D', b: 38 },
          { a: 'E', b: 53 },
          { a: 'F', b: 65 },
          { a: 'G', b: 97 },
          { a: 'H', b: 29 },
          { a: 'I', b: 62 }
        ]
      }]
    }

    context.hotels.forEach((hotel, i) => {
      hotel.index = i
      hotel.id = _.camelCase(hotel.name)
      hotel.reason = window.localStorage.getItem(`reason-${hotel.id}`)
      hotel.checked = JSON.parse(window.localStorage.getItem(`checked-${hotel.id}`)) === true
      hotel.order = JSON.parse(window.localStorage.getItem(`order-${hotel.id}`))
    })
  </script>
  <script>//data to backend
    parseAPI.init()
      function recordResult() {
      
        parseAPI.saveResult(
          {username: 'hello, 3.3', q1: true, q2: false}, 
          {anything: 'you wanna add', numbers: 123, but: {better: 'not object'}} //not obj
        ) 
      console.log("send msg to backend");
    }
  </script>
  <script>
    function pickHotel(index) {
      var hotel = _.find(context.hotels, {index: index});
      hotel.checked = !hotel.checked
      if (!hotel.checked) {
        hotel.order = -1
        window.localStorage.setItem(`order-${hotel.id}`, hotel.order);
      }
      window.localStorage.setItem(`checked-${hotel.id}`, hotel.checked);
    }
  </script>
  <script>
    var source = document.getElementById("hotellist-template").innerHTML;
    var hotellistTemplate = Handlebars.compile(source);

    function sortHotels(attrs, orders) {
      var sorted = _.orderBy(context.hotels, attrs, orders);
      console.log(sorted);
      var rendered = hotellistTemplate({hotels: sorted});
      // console.log(rendered); // Debug
      document.getElementById(`body-hotel-list`).innerHTML = rendered;
      embedVis();
    }
  </script>
  <script>
    var source = document.getElementById("reviewlist-template").innerHTML;
    var reviewlistTemplate = Handlebars.compile(source);


    function filterReviews(hotelIndex, filterParams) {
      var reviews = _.filter(context.hotels[hotelIndex].reviews, filterParams)
      console.log(reviews);
      var rendered = reviewlistTemplate({reviews});
      // console.log(rendered); // Debug
      document.getElementById(`modal-reviews-${hotelIndex}`).innerHTML = rendered;
    }
  </script>
  <script>
    // Funcations to modify content
    Handlebars.registerHelper('addone', value => value + 1);
    Handlebars.registerHelper('isEqual', (value, equalTo) => value === equalTo);

    // Partials, like a component
    Handlebars.registerPartial('hotellist', document.getElementById("hotellist-template").innerHTML);
    Handlebars.registerPartial('reviewmodal', document.getElementById("modal-template").innerHTML);
    Handlebars.registerPartial('reviewlist', document.getElementById("reviewlist-template").innerHTML);

    // Code to render data into template
    var source = document.getElementById("entry-template").innerHTML;
    var template = Handlebars.compile(source);
    var rendered = template(context);
    // console.log(rendered); // Debug
    document.getElementById('handlebars-rendering-target').innerHTML = rendered;
  </script>

  <script id="reorderinglist-template" type="text/x-handlebars-template">
    {{#if (isEqual items.length 3)}}
      <ul class="list-group" id="reorderingitems">
        {{#each items as |item|}}
          <li class="list-group-item" data-item-id="{{item.id}}">
            {{item.name}}
            <p>
              <textarea
                id="textarea-reason-{{item.index}}"
                placeholder="State your reason for chosing this hotel and its order by more than 30 words."
                onkeyup="textareaOnChange({{item.index}})"
              >{{item.reason}}</textarea>
            </p>
          </li>
        {{/each}}
      </ul>
    {{else}}
      You have picked {{items.length}} hotels. Please pick 3 hotels first.
    {{/if}}
  </script>

  <script>
    var source = document.getElementById("reorderinglist-template").innerHTML;
    var reorderinglistTemplate = Handlebars.compile(source);

    $('#modal-picktop').on('shown.bs.modal', function (e) {
      var topHotels = _.filter(context.hotels, {checked: true});
      topHotels = _.orderBy(topHotels, hotel => hotel.order === -1 ? 100 : hotel.order)
      var rendered = reorderinglistTemplate({items: topHotels})
      document.getElementById('picktop-modal-body').innerHTML = rendered;
      if (topHotels.length === 3) {
        var reorderingitems = document.getElementById('reorderingitems');
        Sortable.create(reorderingitems, { animation: 100, group: 'list-1', draggable: '.list-group-item', handle: '.list-group-item', sort: true, filter: '.sortable-disabled', chosenClass: 'active', onSort: onReorderingListSort});
        $('#modal-picktop-save').prop('disabled', false);
      } else {
        $('#modal-picktop-save').prop('disabled', true);
      }
    })

    function onReorderingListSort() {
      var items = $('#reorderingitems li').map(function(){return $(this).attr('data-item-id')}).get();
      context.hotels.forEach(hotel => {
        hotel.order = items.indexOf(hotel.id)
        window.localStorage.setItem(`order-${hotel.id}`, hotel.order);
      })
    }

    function textareaOnChange(index) {
      var hotel = _.find(context.hotels, {index: index});
      var reason = $(`#textarea-reason-${index}`).val();
      hotel.reason = reason;
      window.localStorage.setItem(`reason-${hotel.id}`, reason);
      console.log(hotel, reason);
    }

    function recordOrder() {
      var items = $('#reorderingitems li').map(function(){return $(this).attr('data-item-id')}).get();
      console.log(items)
    }
  </script>
  <script type="text/javascript">
    // code to run after the elements are created
    function embedVis () {
      context.hotels.forEach(hotel => {
        var vegaSpec = {
          $schema: 'https://vega.github.io/schema/vega-lite/v4.json',
          description: 'A simple bar chart with embedded data.',
          data: { values: hotel.data },
          mark: 'bar',
          encoding: {
            x: {
              field: 'a',
              type: 'ordinal'
            },
            y: {
              field: 'b',
              type: 'quantitative'
            }
          }
        }
        vegaEmbed('#vis-' + hotel.index, vegaSpec)
        $('#modal-' + hotel.index).on('shown.bs.modal', function (e) {
          vegaEmbed('#modal-vis-' + hotel.index, vegaSpec)
        })
      })
    }
    embedVis()
  </script>
</body>

</html>
