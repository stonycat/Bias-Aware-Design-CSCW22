<!DOCTYPE html>
<style>

.axis .domain {
  display: none;
}
.node rect {
  cursor: move;
  fill-opacity: .9;
  shape-rendering: crispEdges;
}
.node text {
  pointer-events: none;
  text-shadow: 0 1px 0 #fff;
}
.link {
  fill: none;
  stroke: #000;
  stroke-opacity: .2;
}
.link:hover {
  stroke-opacity: .5;
}

</style>
<svg width="1280" height="560"></svg>
<script src="https://d3js.org/d3.v4.js"></script>
<script src="https://unpkg.com/d3-sankey"></script>
<script src="sankey.js"></script>
<script>
var units = "Widgets";

var svg = d3.select("svg"),
    margin = {top: 20, right: 20, bottom: 30, left: 40},
    width = +svg.attr("width") - margin.left - margin.right,
    height = +svg.attr("height") - margin.top - margin.bottom,
    g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");
var g1 = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var y = d3.scaleBand()			// x = d3.scaleBand()	
    .rangeRound([0, width/3])	// .rangeRound([0, width])
    .paddingInner(0.05)
    .align(0.1);

var x = d3.scaleLinear()		// y = d3.scaleLinear()
    .rangeRound([0, height]);	// .rangeRound([height, 0]);

var z = d3.scaleOrdinal(d3.schemeCategory20);
// var z = d3.scaleOrdinal()
//     .range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"]);

var formatNumber = d3.format(",.0f"),    // zero decimal places
    format = function(d) { return formatNumber(d) + " " + units; },
    color = d3.scaleOrdinal(d3.schemeCategory20);

var sankey = d3.sankey()
    .nodeWidth(10)
    .nodePadding(50)
    .size([width/3, height]);
var path = sankey.link();


var sankeyData = {
  "nodes":[
  {"node":0,"name":"5"}, 
  {"node":1,"name":"4"},
  {"node":2,"name":"3"},
  {"node":3,"name":"2"},
  {"node":4,"name":"1"},
  //--------category------------
  // emotion
  {"node":5,"name":"extremely negative"},
  {"node":6,"name":"negative"},
  {"node":7,"name":"neutral"},
  {"node":8,"name":"positive"},
  {"node":9,"name":"extremely positive"}
  // contribution
  // {"node":5,"name":"1"},
  // {"node":6,"name":"2-5"},
  // {"node":7,"name":"6-10"},
  // {"node":8,"name":"11-20"},
  // {"node":9,"name":"21-50"},
  // {"node":10,"name":"51-100"},
  // {"node":11,"name":"101-300"},
  // {"node":12,"name":"300+"}
  //helpful vote
  // {"node":5,"name":"0"},
  // {"node":6,"name":"1"},
  // {"node":7,"name":"2-5"},
  // {"node":8,"name":"6-10"},
  // {"node":9,"name":"11-20"},
  // {"node":10,"name":"21-50"},
  // {"node":11,"name":"51-100"},
  // {"node":12,"name":"100+"}

  ],
  "links":[
      //emotion
  {"source":0,"target":5,"value": 0},
  {"source":0,"target":6,"value": 10},
  {"source":0,"target":7,"value": 38},
  {"source":0,"target":8,"value": 236},
  {"source":0,"target":9,"value": 152},

  {"source":1,"target":5,"value": 1},
  {"source":1,"target":6,"value": 25},
  {"source":1,"target":7,"value": 69},
  {"source":1,"target":8,"value": 154},
  {"source":1,"target":9,"value": 43},  
  
  {"source":2,"target":5,"value": 3},
  {"source":2,"target":6,"value": 10},
  {"source":2,"target":7,"value": 35},
  {"source":2,"target":8,"value": 42},
  {"source":2,"target":9,"value": 6},

  {"source":3,"target":5,"value": 7},
  {"source":3,"target":6,"value": 20},
  {"source":3,"target":7,"value": 2},
  {"source":3,"target":8,"value": 0},
  {"source":3,"target":9,"value": 0},

  {"source":4,"target":5,"value": 8},
  {"source":4,"target":6,"value": 6},
  {"source":4,"target":7,"value": 1},
  {"source":4,"target":8,"value": 0},
  {"source":4,"target":9,"value": 1}
  //helpv
  // {"source":0,"target":5,"value": 74},
  // {"source":0,"target":6,"value": 36},
  // {"source":0,"target":7,"value": 68},
  // {"source":0,"target":8,"value": 52},
  // {"source":0,"target":9,"value": 61},
  // {"source":0,"target":10,"value": 74},
  // {"source":0,"target":11,"value": 44},
  // {"source":0,"target":12,"value": 21},

  // {"source":1,"target":5,"value": 35},
  // {"source":1,"target":6,"value": 21},
  // {"source":1,"target":7,"value": 38},
  // {"source":1,"target":8,"value": 20},
  // {"source":1,"target":9,"value": 39},
  // {"source":1,"target":10,"value": 56},
  // {"source":1,"target":11,"value": 52},
  // {"source":1,"target":12,"value": 24},

  // {"source":2,"target":5,"value": 17},
  // {"source":2,"target":6,"value": 5},
  // {"source":2,"target":7,"value": 11},
  // {"source":2,"target":8,"value": 5},
  // {"source":2,"target":9,"value": 13},
  // {"source":2,"target":10,"value": 24},
  // {"source":2,"target":11,"value": 10},
  // {"source":2,"target":12,"value": 8},

  // {"source":3,"target":5,"value": 6},
  // {"source":3,"target":6,"value": 2},
  // {"source":3,"target":7,"value": 4},
  // {"source":3,"target":8,"value": 4},
  // {"source":3,"target":9,"value": 7},
  // {"source":3,"target":10,"value": 2},
  // {"source":3,"target":11,"value": 2},
  // {"source":3,"target":12,"value": 2},

  // {"source":4,"target":5,"value": 3},
  // {"source":4,"target":6,"value": 6},
  // {"source":4,"target":7,"value": 2},
  // {"source":4,"target":8,"value": 2},
  // {"source":4,"target":9,"value": 2},
  // {"source":4,"target":10,"value": 0},
  // {"source":4,"target":11,"value": 1},
  // {"source":4,"target":12,"value": 0}
  //contri
  // {"source":0,"target":5,"value": 46},//74},
  // {"source":0,"target":6,"value": 66},//36},
  // {"source":0,"target":7,"value": 37},//68},
  // {"source":0,"target":8,"value": 59},//52},
  // {"source":0,"target":9,"value": 78},//61},
  // {"source":0,"target":10,"value": 61},//74},
  // {"source":0,"target":11,"value": 56},//44},
  // {"source":0,"target":12,"value": 33},//21},

  // {"source":1,"target":5,"value": 16},//35},
  // {"source":1,"target":6,"value": 38},//21},
  // {"source":1,"target":7,"value": 14},//38},
  // {"source":1,"target":8,"value": 30},//20},
  // {"source":1,"target":9,"value": 47},//39},
  // {"source":1,"target":10,"value": 47},//56},
  // {"source":1,"target":11,"value": 62},//52},
  // {"source":1,"target":12,"value": 38},//24},

  // {"source":2,"target":5,"value": 12},//17},
  // {"source":2,"target":6,"value": 13},//5},
  // {"source":2,"target":7,"value": 3},//11},
  // {"source":2,"target":8,"value": 7},//5},
  // {"source":2,"target":9,"value": 14},//13},
  // {"source":2,"target":10,"value": 19},//24},
  // {"source":2,"target":11,"value": 20},//10},
  // {"source":2,"target":12,"value": 8},//8},

  // {"source":3,"target":5,"value": 5},//6},
  // {"source":3,"target":6,"value": 4},//2},
  // {"source":3,"target":7,"value": 5},//4},
  // {"source":3,"target":8,"value": 5},//4},
  // {"source":3,"target":9,"value": 6},//7},
  // {"source":3,"target":10,"value": 0},//2},
  // {"source":3,"target":11,"value": 1},//2},
  // {"source":3,"target":12,"value": 3},//2},

  // {"source":4,"target":5,"value": 4},//3},
  // {"source":4,"target":6,"value": 2},//6},
  // {"source":4,"target":7,"value": 5},//2},
  // {"source":4,"target":8,"value": 2},//2},
  // {"source":4,"target":9,"value": 1},//2},
  // {"source":4,"target":10,"value": 0},//0},
  // {"source":4,"target":11,"value": 2},//1},
  // {"source":4,"target":12,"value": 0}//0}
  ]}
// console.log(sankeyData);


d3.csv("csvtest/data0.csv", function(d, i, columns) {
  for (i = 1, t = 0; i < columns.length; ++i) t += d[columns[i]] = +d[columns[i]];
  d.total = t;
  return d;
}, function(error, data) {
  if (error) throw error;

  var keys = data.columns.slice(1);

  data.sort(function(a, b) { return b.total - a.total; });
  y.domain(data.map(function(d) { return d.State; }));					// x.domain...
  x.domain([0, d3.max(data, function(d) { return d.total; })]).nice();	// y.domain...
  z.domain(keys);

  g.append("g")
    .selectAll("g")
    .data(d3.stack().keys(keys)(data))
    .enter().append("g")
      .attr("fill", function(d) { return z(d.key); })
    .selectAll("rect")
    .data(function(d) { return d; })
    .enter().append("rect")
      .attr("y", function(d) { return y(d.data.State); })	  
      .attr("x", function(d) { return x(d[0]); })			   
      .attr("width", function(d) { return x(d[1]) - x(d[0]); })	
      .attr("height", y.bandwidth());						  

  g.append("g")
      .attr("class", "axis")
      .attr("transform", "translate(0,0)") 				
      .call(d3.axisLeft(y));								

  //sankey
  // sankey(sankeyData);
  g1.attr("transform", "translate(" + 540 + "," + margin.top + ")"); // fix distance for test
  sankey
      .nodes(sankeyData.nodes)
      .links(sankeyData.links)
      .layout(32);

  // add in the links
  var link = g1.append("g").selectAll(".link")
      .data(sankeyData.links)
    .enter().append("path")
      .attr("class", "link")
      .attr("d", path)
      .style("stroke-width", function(d) { return Math.max(1, d.dy); })
      // .attr("transform", "translate(" + 325 + "," + margin.top + ")")
      .sort(function(a, b) { return b.dy - a.dy; });

  link.append("title")
      .text(function(d) { 
        return d.source.name + " â†’ " + 
                d.target.name + "\n" + format(d.value); });

  // add in the nodes
  var node = g1.append("g").selectAll(".node")
      .data(sankeyData.nodes)
    .enter().append("g")
      .attr("class", "node")
      .attr("transform", function(d) { 
      return "translate(" + d.x + "," + d.y + ")"; })
      // .attr("transform", "translate(" + 325 + "," + margin.top + ")");
      .call(d3.drag()
        .subject(function(d) {
          return d;
        })
        .on("start", function() {
          this.parentNode.appendChild(this);
        })
        .on("drag", dragmove));

  node.append("rect")
      .attr("height", function(d) { return d.dy; })
      .attr("width", sankey.nodeWidth())
      .style("fill", function(d) { 
		  return d.color = color(d.name.replace(/ .*/, "")); })
      .style("stroke", function(d) { 
		  return d3.rgb(d.color).darker(2); })
    .append("title")
      .text(function(d) { 
		  return d.name + "\n" + format(d.value); });
    
  // add in the title for the nodes
  node.append("text")
      .attr("x", -6)
      .attr("y", function(d) { return d.dy / 2; })
      .attr("dy", ".35em")
      .attr("text-anchor", "end")
      .attr("transform", null)
      .text(function(d) { return d.name; })
    .filter(function(d) { return d.x < width / 2; })
      .attr("x", 6 + sankey.nodeWidth())
      .attr("text-anchor", "start");


  node.append("title")
      .text(function(d) { return d.name + "\n" + format(d.value); });

  // the function for moving the nodes
  function dragmove(d) {
    d3.select(this)
      .attr("transform", 
            "translate(" 
               + d.x + "," 
               + (d.y = Math.max(
                  0, Math.min(height - d.dy, d3.event.y))
                 ) + ")");
    sankey.relayout();
    link.attr("d", path);
  }
});

</script>