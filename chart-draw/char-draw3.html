<!DOCTYPE html>
<meta charset="utf-8">
<!-- Bootstrap4 core CSS -->
<link href="../css/bootstrap.min.css" rel="stylesheet">
<link href="barchart.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
crossorigin="anonymous"></script>
<script>window.jQuery || document.write('<script src="js/jquery-slim.min.js"><\/script>')</script>
<script src="https://d3js.org/d3.v4.js"></script>
<script src="../js/bootstrap.min.js"></script>
<script src="sankey.js"></script>
<!--data in js-->
<script src="data/emoData.js"></script>
<script src="data/contriData.js"></script>
<!-- <script src="data/contriData.js"></script> -->

<body>
  <div class="row">
    
    <div id='dashboard'></div>
    <div id='legend'>
      
    </div>
  </div>

  <!-- <div class="row">
    <div class="col-md-6" id='sankeyPie'></div>
  </div> -->



  <script>
  function dashboard(id, fData){
      var barColor = 'steelblue';
      //try emo color
      // function segColor(c){ return {ep:"#36f356", positive:"#cf5b82",neutral:"#a481ac", negative:"#7ea6d3", en:"#63beed"}[c]; }
      // function segColor(c){ return {ep:"#fb7f01", positive:"#fdab00",neutral:"#a7a8ac", negative:"#0180d1", en:"#024383"}[c]; }
      
      function segColor(c){ return {
        ep:"#ffd100", positive:"#ffb81b",neutral:"#8bb8e8", negative:"#005587", en:"#003b5c"}[c]; 
      }
      
      
      // function segColor(c){ return {newReviewer:"#caf0f8", reviewer:"#ade8f4",seniorReviewer:"#90e0ef", 
      //       contributor:"#00b4d8", seniorContributor:"#0096c7", proContributor:"#0077b6"}[c]; }
      //compute total for each state.
      //emo
      fData.forEach(function(d){d.total=d.freq.ep+d.freq.positive+d.freq.neutral+d.freq.negative+d.freq.en;});
      //contri
      // fData.forEach(function(d){d.total=d.freq.newReviewer+d.freq.reviewer+d.freq.seniorReviewer
      // +d.freq.contributor+d.freq.seniorContributor+d.freq.proContributor;});
      
      // function to handle histogram.
      function histoGram(fD, nLdata){
          var hG={},    hGDim = {t: 60, r: 0, b: 0, l: 30};
          hGDim.w = 500 - hGDim.l - hGDim.r, 
          hGDim.h = 600 - hGDim.t - hGDim.b;
              
          //create svg for histogram.
          var barY = hGDim.h/2;
          var hGsvg = d3.select(id).append("svg")
              .attr("width", hGDim.w + hGDim.l + hGDim.r)
              .attr("height", hGDim.h + hGDim.t).append("g")
              .attr("transform", "translate(" + hGDim.l + "," + hGDim.t + ")");
  
          // create function for x-axis mapping.
          var x = d3.scaleBand().range([0, hGDim.w]).padding(0.2)//rangeRound([0, hGDim.w], 2.0) //v3 d3.scale.ordinal().rangeRoundBands([0, hGDim.w], 0.1)
                  .domain(fD.map(function(d) { return d[0]; }));
          // Create function for y-axis map.
          var y = d3.scaleLinear().range([barY, 0])// v3 d3.scale.linear().range([hGDim.h, 0])
                  .domain([0, d3.max(fD, function(d) { return d[1]; })]);
  
          // Create bars for histogram to contain rectangles and freq labels.
          var bars = hGsvg.selectAll(".bar").data(fD).enter()
                  .append("g").attr("class", "bar");
          
          //create the rectangles.
          bars.append("rect")
              .attr("x", function(d) { 
                // console.log("barX", x(d[0]));
                return x(d[0]); 
              })
              .attr("y", function(d) { return y(d[1]); })
              .attr("width", x.bandwidth())//rangeBand())
              .attr("height", function(d) { return hGDim.h/2 - y(d[1]); })
              .attr('fill',barColor)
              .on("mouseover",mouseover)// mouseover is defined below.
              .on("mouseout",mouseout);// mouseout is defined below.
              
          //Create the frequency labels above the rectangles.
          bars.append("text").text(function(d){ return d3.format(",")(d[1])})
              .attr("x", function(d) { return x(d[0])+x.bandwidth()/2; })
              .attr("y", function(d) { return y(d[1])-10; })
              .attr("text-anchor", "middle");  
          
          bars.attr("id", "tooltip")

          // Add x-axis to the histogram svg.
          hGsvg.append("g").attr("class", "x axis")
              // .style("font-size", "9px")
              .attr("transform", "translate(0," + hGDim.h/2 + ")")
              .call(d3.axisTop().tickSize(0).scale(x));
              //v3 .call(d3.svg.axis().scale(x).orient("bottom"));
          
          
          //*****add sankey chart in this svg*******//
          var maxNodeY = Math.max(nLdata.links[0].value, nLdata.links[1].value,
            nLdata.links[2].value,nLdata.links[3].value,nLdata.links[4].value);

          var minNodeY = Math.min(nLdata.links[0].value, nLdata.links[1].value,
            nLdata.links[2].value,nLdata.links[3].value,nLdata.links[4].value);

          // console.log(minNodeY, maxNodeY);
          var pieSankey = hGsvg.append("g").attr("class", "sankeyPie")
              .attr("width", hGDim.w + hGDim.l + hGDim.r)
              .attr("height", hGDim.h/6)
              .attr("transform", "translate(" + 0 + "," + barY + ")");
        
          var sankey = d3.sankey()
            .nodeWidth(5) // node.dx = nodeWidth
            .nodePadding(80) 
            .size([hGDim.w, hGDim.h/6]);

          var sankeyPath = sankey.link();
          
          sankey
              .nodes(nLdata.nodes)
              .links(nLdata.links)
              .layout(32); // what is this? iterations

          var link = pieSankey.append("g").selectAll(".link").data(nLdata.links)
              .enter().append("path")
              .attr("class", "link");  
              
          var node = pieSankey.append("g").selectAll(".node")
              .data(nLdata.nodes)
            .enter().append("g")
              .attr("class", "node")
              .attr("transform", function(d, i) {
                  // console.log(i);
                  switch(i) {
                    case 0: 
                    case 5:{
                      d.x = x("5") + (x.bandwidth()-d.dy) / 2; 
                      break;
                    }
                    case 1: 
                    case 6:{
                      d.x = x("4") + (x.bandwidth()-d.dy) / 2; 
                      break;
                    }
                    case 2: 
                    case 7:{
                      d.x = x("3") + (x.bandwidth()-d.dy) / 2; 
                      break;
                    }
                    case 3: 
                    case 8:{
                      d.x = x("2") + (x.bandwidth()-d.dy) / 2; 
                      break;
                    }
                    case 4: 
                    case 9:{
                      d.x = x("1") + (x.bandwidth()-d.dy) / 2; 
                      break;
                    }
                  };
                  return "translate(" + d.x + "," + d.y + ")"; 
              })
              .call(d3.drag()
              .on("drag", dragmove));

            //add rect as uppernode
            node.filter(function(d){
                return !d.pieData; //add rect
              }).append("rect")
                .attr("height", sankey.nodeWidth())
                .attr("width", function(d) { 
                  // console.log(d.dy, x.bandwidth());
                  return Math.min(d.dy, x.bandwidth()); })
                .style("fill", "#ADB5BD");


            //render link later for alignment 
            link.attr("d", sankeyPath)
              .style("stroke-width", function(d) { 
                return Math.min(d.dy, x.bandwidth()); 
              })
              .style("stroke", "#ADB5BD")
              .sort(function(a, b) { 
                return b.dy - a.dy; 
              });

          var arc = d3.arc()
              .outerRadius(40)
              .innerRadius(0);//donut to pie
          
          var pie = d3.pie()
                .sort(null)
                .value(function(d) { return d.value; });
          
          var g = node.filter(function(d){
              return d.pieData;
            }).append("g")
            .attr('transform', function(d,i){ // have been transformed by d.x d.y
              return 'translate('+d.dy/2+',' + 0 + ')';// just change d.x
            })
            .attr("class","pie")
            .selectAll(".arc")
            .data(function(d){return pie(d.pieData);})
            .enter().append("g")
            .attr("class", "arc");

            g.append("path")
              .attr("d", arc)
              .attr("fill",function(d,i){ 
                // console.log(d);
                return segColor(d.data.type); 
              })
      
          function dragmove(d) {
            //d3.select(this).attr("transform", "translate(" + d.x + "," + (d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))) + ")");
            d3.select(this).attr("transform", "translate(" + (d.x = Math.max(0, Math.min(hGDim.w - d.dy, d3.event.x))) + "," + d.y + ")");
            sankey.relayout();
            link.attr("d", sankeyPath);
          }
          
          function mouseover(d){  // utility function to be called on mouseover.
              // filter for selected state.
              var st = fData.filter(function(s){ return s.State == d[0];})[0],
                  nD = d3.keys(st.freq).map(function(s){ return {type:s, freq:st.freq[s]};});

              leg.update(nD);
              // add bar tooltip 

          }
          
          function mouseout(d){    // utility function to be called on mouseout.
              // reset the pie-chart and legend.    
              leg.update(tF);
          }
          
          // create function to update the bars. This will be used by pie-chart.
          hG.update = function(nD, color){
              // update the domain of the y-axis map to reflect change in frequencies.
              y.domain([0, d3.max(nD, function(d) { return d[1]; })]);
              
              // Attach the new data to the bars.
              var bars = hGsvg.selectAll(".bar").data(nD);
              
              // transition the height and color of rectangles.
              bars.select("rect").transition().duration(500)
                  .attr("y", function(d) {return y(d[1]); })
                  .attr("height", function(d) { return barY - y(d[1]); })
                  .attr("fill", color);
  
              // transition the frequency labels location and change value.
              bars.select("text").transition().duration(500)
                  .text(function(d){ return d3.format(",")(d[1])})
                  .attr("y", function(d) {return y(d[1])-10; });            
          }        
          return hG;
      }
      
      function sankeyPie(nLdata){
        var marginPie = {top: 0, right: 0, bottom: 40, left: 32},
            width = 500 - marginPie.left - marginPie.right, 
            height = 150 - marginPie.top - marginPie.bottom; 
        
        var formatNumber = d3.format(",.0f"),
            format = function(d) { 
              return formatNumber(d) + " TWh"; 
            },
            // color = d3.scaleOrdinal(d3.schemeCategory20);
            color = d3.scaleOrdinal(["#ffd100", "#ffb81b","#8bb8e8", "#005587", "#003b5c"]); 
            
        var svg = d3.select("#sankeyPie").append("svg")
            .attr("width", width + marginPie.left + marginPie.right)
            .attr("height", height + marginPie.top + marginPie.bottom)
          .append("g")
            .attr("transform", "translate(" + marginPie.left + "," + marginPie.top + ")");
        
        var sankey = d3.sankey()
            .nodeWidth(5) // node.dx = nodeWidth
            .nodePadding(68) 
            .size([width, height]);

        var path = sankey.link();
          sankey
              .nodes(nLdata.nodes)
              .links(nLdata.links)
              .layout(32); // what is this? iterations

        var link = svg.append("g").selectAll(".link")
            .data(nLdata.links)
            .enter().append("path")
            .attr("class", "link")
            .attr("d", path)
            .style("stroke-width", function(d) { 
              return Math.max(1, d.dy); 
            })
            .style("stroke", "#adb5bd")
            //function(d) { 
              //return d.source.color = color(d.source.name.replace(/ .*/, "")); })
            .sort(function(a, b) { 
              return b.dy - a.dy; 
            });

        var node = svg.append("g").selectAll(".node")
              .data(energy.nodes)
            .enter().append("g")
              .attr("class", "node")
              .attr("transform", function(d) {
                  return "translate(" + d.x + "," + d.y + ")"; 
              })
              .call(d3.drag()
              // .origin(function(d) { return d; })
              // .on("dragstart", function() { this.parentNode.appendChild(this); })
              .on("drag", dragmove));

          //add rect as uppernode
          node.filter(function(d){
              return !d.pieData; //add rect
          }).append("rect")
              .attr("height", sankey.nodeWidth())
              .attr("width", function(d) { return Math.max(1, d.dy); })
              .style("fill", "#ADB5BD");
              // .attr("transform", function(d) {
              //     return "translate(" + d.x + "," + d.y + ")"; 
              // });
              // .style("fill", function(d) { 
              //   return d.color = color(d.name.replace(/ .*/, "")); 
              // });
        

        //add pie as uppernode      
        var arc = d3.arc()
              .outerRadius(40)
              .innerRadius(0);//donut to pie
          
        var pie = d3.pie()
              .sort(null)
              .value(function(d) { return d.value; });
          
        var g = node.filter(function(d){
            return d.pieData;
          }).append("g")
          .attr('transform', function(d,i){ // have been transformed by d.x d.y
            return 'translate('+d.dy/2+')';// just change d.x
          })
          .attr("class","pie")
          .selectAll(".arc")
          .data(function(d){return pie(d.pieData);})
          .enter().append("g")
          .attr("class", "arc");

          g.append("path")
            .attr("d", arc)
            .attr("fill",function(d,i){ 
              // console.log(d);
              return segColor(d.data.type); 
            })

              
        function dragmove(d) {
            //d3.select(this).attr("transform", "translate(" + d.x + "," + (d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))) + ")");
            d3.select(this).attr("transform", "translate(" + (d.x = Math.max(0, Math.min(width - d.dy, d3.event.x))) + "," + d.y + ")");
            sankey.relayout();
            link.attr("d", path);
          }

      }
      
      
      // function to handle pieChart.
      function pieChart2(pD){
        var pC ={},    pieDim ={w:100, h: 100};
          pieDim.r = Math.min(pieDim.w, pieDim.h) / 2;
                  
          // create svg for pie chart.
          var piesvg = d3.select("#piesvg").append("svg")
              .attr("width", pieDim.w).attr("height", pieDim.h).append("g")
              .attr("transform", "translate("+pieDim.w/2+","+pieDim.h/2+")");
          
          // create function to draw the arcs of the pie slices.
          var arc = d3.arc().outerRadius(pieDim.r - 10).innerRadius(0);
                      // .startAngle(function(d) { return d.startAngle - Math.PI/2; })
                      // .endAngle(function(d) { return d.endAngle - Math.PI/2; });
  
          // create a function to compute the pie slice angles.
          var pie = d3.pie().sort(null).value(function(d) { 
            // console.log("read pie", d.freq);
            return d.freq; 
          });
  
          // Draw the pie slices.
          var names = ['ep', 'poitive', 'neutral', 'negative', 'en'];
          piesvg.selectAll("path").data(pie(pD)).enter().append("path").attr("d", arc)
              .each(function(d) { this._current = d; })
              .style("fill", function(d) { return segColor(d.data.type); })
              .on("mouseover", function(d, i) {
                  piesvg.append("text")
                    .attr("dy", ".5em")
                    .style("text-anchor", "middle")
                    .style("font-size", 10)
                    .attr("class","label")
                    .style("fill", function(d,i){return "black";})
                    .text(names[i]); 
              }).on("mouseout", function(d) {
                piesvg.select(".label").remove();
              });
              // .on("mouseover",mouseover).on("mouseout",mouseout);

          // Utility function to be called on mouseover a pie slice.
          function mouseover(d){
              // call the update function of histogram with new data.
              hG.update(fData.map(function(v){ 
                  return [v.State,v.freq[d.data.type]];}),segColor(d.data.type));
          }
          //Utility function to be called on mouseout a pie slice.
          function mouseout(d){
              // call the update function of histogram with all data.
              hG.update(fData.map(function(v){
                  return [v.State,v.total];}), barColor);
          }

          return pC;
      }

      // function to handle legend.
      function legend(lD){
          var leg = {}, legDim = {t: 0, r: 0, b: 0, l: 20};
          legDim.w = 300 - legDim.l - legDim.r, 
          legDim.h = 180 - legDim.t - legDim.b;
          // create table for legend.
          var legend = d3.select("#legend").append("table").attr('class','legend')
              .attr("width", legDim.w + legDim.l + legDim.r)
              .attr("height", legDim.h + legDim.t + legDim.b)
              .attr("transform", "translate(" + legDim.l + ",0");
          
          // create one row per segment.
          var tr = legend.append("tbody").selectAll("tr").data(lD).enter().append("tr");
              
          // create the first column for each segment.
          tr.append("td").append("svg").attr("width", '16').attr("height", '16').append("rect")
              .attr("width", '16').attr("height", '16')
              .attr("fill",function(d){ return segColor(d.type); })
              .on("mouseover",mouseover).on("mouseout",mouseout);
              
          // create the second column for each segment.
          tr.append("td").text(function(d){ return d.type;});
  
          // create the third column for each segment.
          tr.append("td").attr("class",'legendFreq')
              .text(function(d){ return d3.format(",")(d.freq);});
  
          // create the fourth column for each segment.
          tr.append("td").attr("class",'legendPerc')
              .text(function(d){ 
                return getLegend(d,lD);
              });
  
          // Utility function to be used to update the legend.
          leg.update = function(nD){
              // update the data attached to the row elements.
              var l = legend.select("tbody").selectAll("tr").data(nD);
  
              // update the frequencies.
              l.select(".legendFreq").text(function(d){ return d3.format(",")(d.freq);});
  
              // update the percentage column.
              l.select(".legendPerc").text(function(d){ return getLegend(d,nD);});        
          }
          
          function getLegend(d,aD){ // Utility function to compute percentage.
              // return d3.format("%")(d.freq/d3.sum(aD.map(function(v){ return v.freq; })));
              var tempperc = d.freq/d3.sum(aD.map(function(v){ return v.freq; }));
              return d3.format(".2%")(tempperc.toFixed(4));
          }
          function mouseover(d){
              // call the update function of histogram with new data.
              hG.update(fData.map(function(v){ 
                  return [v.State,v.freq[d.type]];}),segColor(d.type));
          }
          //Utility function to be called on mouseout a pie slice.
          function mouseout(d){
              // call the update function of histogram with all data.
              hG.update(fData.map(function(v){
                  return [v.State,v.total];}), barColor);
          }
  
          return leg;
      }
      
      // calculate total frequency by segment for all state.
      //emo
      var tF = ['ep','positive','neutral','negative','en'].map(function(d){ 
          return {type:d, freq: d3.sum(fData.map(function(t){ return t.freq[d];}))}; 
      });    
      //contri
      // var tF = ['newReviewer','reviewer','seniorReviewer','contributor', 'seniorContributor', 
      // 'proContributor'].map(function(d){ 
      //     return {type:d, freq: d3.sum(fData.map(function(t){ return t.freq[d];}))}; 
      // });    
      
      // calculate total frequency by state for all segment.
      var sF = fData.map(function(d){return [d.State,d.total];});

      var st5 = fData.filter(function(s){ return s.State;})[0],
                nD5 = d3.keys(st5.freq).map(function(s){ return {type:s, freq:st5.freq[s]};});
      var st4 = fData.filter(function(s){ return s.State;})[1],
                nD4 = d3.keys(st4.freq).map(function(s){ return {type:s, freq:st4.freq[s]};})
      var st3 = fData.filter(function(s){ return s.State;})[2],
                nD3 = d3.keys(st3.freq).map(function(s){ return {type:s, freq:st3.freq[s]};})
      var st2 = fData.filter(function(s){ return s.State;})[3],
                nD2 = d3.keys(st2.freq).map(function(s){ return {type:s, freq:st2.freq[s]};})
      var st1 = fData.filter(function(s){ return s.State;})[4],
                nD1 = d3.keys(st1.freq).map(function(s){ return {type:s, freq:st1.freq[s]};})
      //console.log("all data:", fData);

      var energy = {
          "nodes": [{
            "node": 0,
            "name": "1"
          },  {
            "node": 1,
            "name": "2"
          }, {
            "node": 2,
            "name": "3"
          }, {
            "node": 3,
            "name": "4"
          }, {
            "node": 4,
            "name": "5"
          },{
            "node": 5,
            "name": "6",
            "pieData": [{
              "value": Math.random()
            },{
              "value": Math.random()
            },{
              "value": Math.random()
            },{
              "value": Math.random()
            },{
              "value": Math.random()
            }]
          },{
            "node": 6,
            "name": "7",
            "pieData": [{
              "value": Math.random()
            },{
              "value": Math.random()
            },{
              "value": Math.random()
            },{
              "value": Math.random()
            },{
              "value": Math.random()
            }]
          },
          {
            "node": 7,
            "name": "8",
            "pieData": [{
              "value": Math.random()
            },{
              "value": Math.random()
            },{
              "value": Math.random()
            },{
              "value": Math.random()
            },{
              "value": Math.random()
            }]
          },
          {
            "node": 8,
            "name": "9",
            "pieData": [{
              "value": Math.random()
            },{
              "value": Math.random()
            },{
              "value": Math.random()
            },{
              "value": Math.random()
            },{
              "value": Math.random()
            }]
          }, {
            "node": 9,
            "name": "10",
            "pieData": [{
              "value": Math.random()
            },{
              "value": Math.random()
            },{
              "value": Math.random()
            },{
              "value": Math.random()
            },{
              "value": Math.random()
            }]
          }
        ], //all nodes
          "links": [{
            "source": 0,
            "target": 5,
            "value": 64
          }, {
            "source": 1,
            "target": 6,
            "value": 54  //node.dy = node.value * ky, ky~nodePadding & value
          },
          {
            "source": 2,
            "target": 7,
            "value": 15  //node.dy = node.value * ky, ky~nodePadding & value
          }, {
            "source": 3,
            "target": 8,
            "value": 1  //node.dy = node.value * ky, ky~nodePadding & value
          },
          {
            "source": 4,
            "target": 9,
            "value": 7  //node.dy = node.value * ky, ky~nodePadding & value
          }]// all links
        }    
      // console.log(linkNum1);
      energy.links.map((link, index, arr) => {
        ind = (index+1).toString()
        
        if (ind == "5") ind2 = "1"
        if (ind == "4") ind2 = "2"
        if (ind == "3") ind2 = "3"
        if (ind == "2") ind2 = "4"
        if (ind == "1") ind2 = "5"
        // console.log(link.value, ind2);
        link.value = linkNum1[ind2];
      })

      // read link data from fData
      energy.nodes.map((item, index, arr)=>{
        // console.log(item.name);
        if (item.hasOwnProperty("pieData")) { // 5 nodes with pie
          // console.log(fData[index-5]['freq']); // 5-1 point
          // console.log(Object.keys(fData[index-5]['freq']));
          item.pieData.map((itemPie, indPie, arrPie) => {            
            // console.log(itemPie); 
            itemPie.value = fData[index-5]['freq'][Object.keys(fData[index-5]['freq'])[indPie]];
            itemPie.type = Object.keys(fData[index-5]['freq'])[indPie];
          });
        }
      })
      // console.log("post-process:", energy.nodes);
      
      //sankeyPie(energy);
      var hG = histoGram(sF, energy), // create the histogram.
          // pC1 = pieChart2(nD5),
          // pC2 = pieChart2(nD4),
          // pC3 = pieChart2(nD3),
          // pC4 = pieChart2(nD2),
          // pC5 = pieChart2(nD1);
          leg= legend(tF);  // create the legend.

  }
  </script>
  
  <script>
  dashboard('#dashboard', hotelNum1);
  // dashboard('#dashboard', barContriData);
  </script>
