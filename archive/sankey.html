<!DOCTYPE html>
<html>

<head>
  <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
  <script src="http://rawgit.com/d3/d3-plugins/master/sankey/sankey.js"></script>
  <style>
    .node rect {
      cursor: move;
      fill-opacity: .9;
      shape-rendering: crispEdges;
    }
    .node text {
      pointer-events: none;
      text-shadow: 0 1px 0 #fff;
    }
    .link {
      fill: none;
      stroke: #000;
      stroke-opacity: .2;
    }
    .link:hover {
      stroke-opacity: .5;
    }
  </style>

</head>

<body>
  <script>
    var someData = {
      "nodes": [{
        "node": 0,
        "name": "node0"
      }, {
        "node": 1,
        "name": "node1"
      }, {
        "node": 2,
        "name": "node2"
      }, {
        "node": 3,
        "name": "node3",
        "pieData": [{
          "value": Math.random()
        },{
          "value": Math.random()
        },{
          "value": Math.random()
        }]
      }],
      "links": [{
        "source": 0,
        "target": 1,
        "value": 2
      }, {
        "source": 2,
        "target": 3,
        "value": 2
      }]
    }

    var margin = {
      top: 50,
      right: 50,
      bottom: 50,
      left: 50
    },
      width = 600 - margin.left - margin.right,
      height = 500 - margin.top - margin.bottom;

    var formatNumber = d3.format(",.0f"),
      format = function(d) {
        return formatNumber(d) + " TWh";
      },
      color = d3.scale.category20();

    var svg = d3.select("body").append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    var sankey = d3.sankey()
      .nodeWidth(15)
      .nodePadding(200)
      .size([width, height]);

    var path = sankey.link();

    sankey
      .nodes(someData.nodes)
      .links(someData.links)
      .layout(32);

    var link = svg.append("g").selectAll(".link")
      .data(someData.links)
      .enter().append("path")
      .attr("class", "link")
      .attr("d", path)
      .style("stroke-width", function(d) {
        return Math.max(1, d.dy);
      })
      .style("stroke", function(d) { 
        return d.source.color = color(d.source.name.replace(/ .*/, "")); })
      .sort(function(a, b) {
        return b.dy - a.dy;
      });

    link.append("title")
      .text(function(d) {
        return d.source.name + " â†’ " + d.target.name + "\n" + format(d.value);
      });

    var node = svg.append("g").selectAll(".node")
      .data(someData.nodes)
      .enter().append("g")
      .attr("class", "node")
      .attr("transform", function(d) {
        return "translate(" + d.x + "," + d.y + ")";
      });

    node.filter(function(d){
        return !d.pieData;
      })
      .append("rect")
      .attr("width", sankey.nodeWidth()) //change vertical
      .attr("height", function(d) {
        return d.dy;
      })
      .style("fill", function(d) {
        return d.color = color(d.name.replace(/ .*/, ""));
      })
      .style("stroke", function(d) {
        return d3.rgb(d.color).darker(2);
      })
      .append("title")
      .text(function(d) {
        return d.name + "\n" + format(d.value);
      });
      
    var pColor = d3.scale.ordinal()
        .range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"]);

    var arc = d3.svg.arc()
        .outerRadius(50)
        .innerRadius(20);
    
    var pie = d3.layout.pie()
        .sort(null)
        .value(function(d) { return d.value; });
      
    var g = node.filter(function(d){
        return d.pieData;
      })
      .append("g")
      .attr('transform', function(d,i){
        console.log(d.dy);
        return 'translate('+d.dx/2+','+d.dy/2+')';
      })
      .attr("class","donut")
      .selectAll(".arc")
      .data(function(d){return pie(d.pieData);})
      .enter().append("g")
      .attr("class", "arc");

    g.append("path")
      .attr("d", arc)
      .style("fill", function(d,i) { return color(i); });

    node.append("text")
      .attr("x", -6)
      .attr("y", function(d) {
        return d.dy / 2;
      })
      .attr("dy", ".35em")
      .attr("text-anchor", "end")
      .attr("transform", null)
      .text(function(d) {
        return d.name;
      })
      .filter(function(d) {
        return d.x < width / 2;
      })
      .attr("x", 6 + sankey.nodeWidth())
      .attr("text-anchor", "start");
  </script>
</body>

</html>