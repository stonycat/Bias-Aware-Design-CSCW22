<!DOCTYPE html>
<html>
    <head>
        <title>Vertical Sankey</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="styles/style.css" type="text/css"/>
        <script src="https://d3js.org/d3.v4.js"></script>
        <script src="scripts/sankey.js"></script>
    </head>
    <body>
        <p id="chart">
            
        <script>
        var energy = {
          "nodes": [{
            "node": 0,
            "name": "node0"
          }, {
            "node": 1,
            "name": "node1",
            "pieData": [{
              "value": Math.random()
            },{
              "value": Math.random()
            },{
              "value": Math.random()
            }]
          }, {
            "node": 2,
            "name": "node2"
          }, {
            "node": 3,
            "name": "node3",
            "pieData": [{
              "value": Math.random()
            },{
              "value": Math.random()
            },{
              "value": Math.random()
            }]
          },
          {
            "node": 4,
            "name": "node4"
          }, {
            "node": 5,
            "name": "node5",
            "pieData": [{
              "value": Math.random()
            },{
              "value": Math.random()
            },{
              "value": Math.random()
            }]
          },
          {
            "node": 6,
            "name": "node6"
          }, {
            "node": 7,
            "name": "node7",
            "pieData": [{
              "value": Math.random()
            },{
              "value": Math.random()
            },{
              "value": Math.random()
            }]
          },{
            "node": 8,
            "name": "node8"
          }, {
            "node": 9,
            "name": "node9",
            "pieData": [{
              "value": Math.random()
            },{
              "value": Math.random()
            },{
              "value": Math.random()
            }]
          }
        ], //all nodes
          "links": [{
            "source": 0,
            "target": 1,
            "value": 436
          }, {
            "source": 2,
            "target": 3,
            "value": 292  //node.dy = node.value * ky, ky~nodePadding & value
          },
          {
            "source": 4,
            "target": 5,
            "value": 96  //node.dy = node.value * ky, ky~nodePadding & value
          }, {
            "source": 6,
            "target": 7,
            "value": 29  //node.dy = node.value * ky, ky~nodePadding & value
          },
          {
            "source": 8,
            "target": 9,
            "value": 16  //node.dy = node.value * ky, ky~nodePadding & value
          }]// all links
        }
        var margin = {top: 50, right: 50, bottom: 50, left: 50},
            width = 900 - margin.left - margin.right, 
            height = 200 - margin.top - margin.bottom; 

        var formatNumber = d3.format(",.0f"),
            format = function(d) { 
              return formatNumber(d) + " TWh"; 
            },
            color = d3.scaleOrdinal(d3.schemeCategory20);

        var svg = d3.select("#chart").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
          .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var sankey = d3.sankey()
            .nodeWidth(2) // node.dx = nodeWidth
            .nodePadding(150) 
            .size([width, height]);

        var path = sankey.link();

        // d3.json("data/energy.json", function(energy) {
          sankey
              .nodes(energy.nodes)
              .links(energy.links)
              .layout(32); // what is this? iterations

          var link = svg.append("g").selectAll(".link")
              .data(energy.links)
              .enter().append("path")
              .attr("class", "link")
              .attr("d", path)
              .style("stroke-width", function(d) { 
                return Math.max(1, d.dy); 
              })
              .style("stroke", function(d) { 
                return d.source.color = color(d.source.name.replace(/ .*/, "")); })
              .sort(function(a, b) { 
                return b.dy - a.dy; 
              });

          // link.append("title")
          //     .text(function(d) { 
          //       return d.source.name + " â†’ " + d.target.name + "\n" + format(d.value); 
          //     });
              // title is an SVG standard way of providing tooltips, up to the browser how to render this, so changing the style is tricky
            
          var node = svg.append("g").selectAll(".node")
              .data(energy.nodes)
            .enter().append("g")
              .attr("class", "node")
              .attr("transform", function(d) {
                  return "translate(" + d.x + "," + d.y + ")"; 
              })
              .call(d3.drag()
              // .origin(function(d) { return d; })
              // .on("dragstart", function() { this.parentNode.appendChild(this); })
              .on("drag", dragmove));

          //add rect as uppernode
          node.filter(function(d){
              return !d.pieData; //add rect
          }).append("rect")
              .attr("height", sankey.nodeWidth())
              .attr("width", function(d) { return d.dy; })
              .style("fill", function(d) { 
                return d.color = color(d.name.replace(/ .*/, "")); 
              });
              // .style("stroke", function(d) { 
              //   return d3.rgb(d.color).darker(0); 
              // });
            // .append("title")
            //   .text(function(d) { 
            //     return d.name + "\n" + format(d.value); 
            //   });
          
          //add pie as uppernode
          var pColor = d3.scaleBand()
            .range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"]);
          var arc = d3.arc()
              .outerRadius(50)
              .innerRadius(0);//donut to pie
          
          var pie = d3.pie()
              .sort(null)
              .value(function(d) { return d.value; });
          
          var g = node.filter(function(d){
            return d.pieData;
          }).append("g")
          .attr('transform', function(d,i){ // have been transformed by d.x d.y
            return 'translate('+d.dy/2+')';// just change d.x
          })
          .attr("class","pie")
          .selectAll(".arc")
          .data(function(d){return pie(d.pieData);})
          .enter().append("g")
          .attr("class", "arc");

          g.append("path")
            .attr("d", arc)
            .style("fill", function(d,i) { return color(i); });

              
          function dragmove(d) {
            //d3.select(this).attr("transform", "translate(" + d.x + "," + (d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))) + ")");
            d3.select(this).attr("transform", "translate(" + (d.x = Math.max(0, Math.min(width - d.dy, d3.event.x))) + "," + d.y + ")");
            sankey.relayout();
            link.attr("d", path);
          }
        // });
        </script>
    </body>
</html>