<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">

  <title>Booking Hotel</title>

  <!-- Bootstrap4 core CSS -->
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/hotel.css" rel="stylesheet">
  <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>


  <!-- Bootstrap4 core JavaScript
  ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->

  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
    integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
    crossorigin="anonymous"></script>
  <script>window.jQuery || document.write('<script src="js/jquery-slim.min.js"><\/script>')</script>
  <script src="https://d3js.org/d3.v4.js"></script>
  <script src="js/sankey.js"></script>
  <script src="js/parse.js"></script>
  <script type="text/javascript" src="https://unpkg.com/parse/dist/parse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/RubaXa/Sortable/Sortable.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.0/jquery.cookie.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="js/popper.min.js"></script>
  <script src="js/bootstrap.min.js"></script>  
  <script src="js/holder.min.js"></script>
  <script src="https://kit.fontawesome.com/4421af3ebc.js" crossorigin="anonymous"></script>
  <script type="text/javascript" src="https://unpkg.com/lodash@4.17.20/lodash.min.js"></script>

  <script src="js/data/emoData15.js"></script>
  <script src="js/data/contriData15.js"></script>
  <script src="js/data/keyword15.js"></script>
  <script src="json/Alhambra_Hotel_95_4.0.js"></script>
  <script src="json/Chelsea_Guest_House_93_4.0.js"></script>
  <script src="json/Ibis_London_Blackfriars_Hotel_90_4.0.js"></script>
  <script src="json/Ibis_London_City_Shoreditch_Hotel_101_4.0.js"></script>
  <script src="json/Ibis_London_Greenwich_81_4.0.js"></script>
  <script src="json/Ibis_Styles_London_Southwark_99_4.0.js"></script>
  <script src="json/La_Suite_West_Hyde_Park_102_4.0.js"></script>
  <script src="json/London_House_Hotel_108_4.0.js"></script>
  <script src="json/The_Z_Hotel_Victoria_93_4.0.js"></script>
  <script src="json/Travelodge_London_Bethnal_Green_88_4.0.js"></script>
  <script src="json/Travelodge_London_Central_City_Road_99_4.0.js"></script>
  <script src="json/Travelodge_London_Docklands_84_4.0.js"></script>
  <script src="json/Travelodge_London_Excel_84_4.0.js"></script>
  <script src="json/Travelodge_London_Greenwich_High_Road_99_4.0.js"></script>
  <script src="json/Travelodge_London_Vauxhall_Hotel_95_4.0.js"></script>
  <script type="text/javascript" src="json/t1.js"></script> 
</head>

<body>
  <!-- Empty element, will be filled in the content by the code below -->
  <div id="handlebars-rendering-target"></div>

  <!-- <div class="modal fade" id="zqmodal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          ...
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary">Save changes</button>
        </div>
      </div>
    </div>
  </div>
  <script type="text/javascript">
    $(document).ready(function() {
        if ($.cookie('pop') == null) {
            $('#zqmodal').modal('show');
            $.cookie('pop', '1');
        }
    });
  </script> -->

  <script id="entry-template" type="text/x-handlebars-template">
    {{!-- Template, mixing html with handlebars syntax --}}
    <div class="body">
      <div class="container">
      <!-- <h1>{{title}}</h1> --> <!--Header-->
      <header class="blog-header py-3">
        <div class="row flex-nowrap justify-content-between align-items-center">
          <div class="col-4 pt-1">
            <a class="text-muted" href="#">Hotel Web</a>
          </div>
          <div class="col-4 text-center">
          </div>
          <div class="col-4 d-flex justify-content-end align-items-center">
            <a class="btn btn-sm btn-outline-secondary" href="#">Consent Form</a>
          </div>
        </div>
      </header>
<!-- Imagine that you are going on vacation to London, a city you have never been to.  -->
      <div class="jumbotron p-3 p-md-5 text-white rounded bg-dark">
        <div class="col-md-12 px-0">
          <h1 class="display-5 font-italic">Task Design</h1>
          <p class="lead">
            The 15 hotels selected according to the given conditions are shown below.</p>
            Please refer to the user feedback to select the top 3 hotels you would like to stay at most and give your reasons.
        </div>
        <br>
          <button type="button" class="btn btn-outline-success btn-sm" data-toggle="modal" data-target="#modal-picktop">
            Picked Top 3
          </button>
          <!-- <button type="button" class="btn btn-outline-primary btn-sm" onclick="sortHotels(['rating'], ['asc'])">
            SortByRating
          </button> -->
          <button type="button" class="btn btn-outline-primary btn-sm" onclick="sortHotels(['name'], ['asc'])">
            Reorder hotels
          </button>
          <!-- <div class="form-group col-md-2" style="display: inline-block;">
            <input type="email" class="form-control form-control-sm" id="inputEmail3" placeholder="Your ID">
          </div> -->
      </div>
      <!--Header end-->   
        <div id="body-hotel-list">
          {{> hotellist hotels=hotels}}
        </div>
      </div><!--container end-->
    </div><!--body end-->
    <!--rank card -->
    <div class="modal fade" id="modal-picktop" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalLabel">Drag to rank these hotels</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body" id="picktop-modal-body">

          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <button id="modal-picktop-save" type="button" class="btn btn-primary" onclick="recordOrder()">Save changes</button>
          </div>
        </div>
      </div>
    </div>
    <!--rank card -->
  </script>


  <script id="hotellist-template" type="text/x-handlebars-template">
    <!--hotel card start-->
    {{#each hotels as |hotel| }}
    <div class="row mb-2">
      <div class="col-md-12">
        <div class="card flex-md-row mb-4 box-shadow h-md-280">
          <!--choose hotels-->
          {{#if hotel.checked}}
          <input class="form-check-input selectHotel" type="checkbox" value="" 
            id="checkbox-hotel-{{hotel.index}}" onchange="pickHotel({{hotel.index}})" checked>
          {{else}}
          <input class="form-check-input" type="checkbox" value="" 
            id="checkbox-hotel-{{hotel.index}}" onchange="pickHotel({{hotel.index}})">
          {{/if}}
          <!--choose hotels-->
          
          <img class="card-img-left flex-auto d-none d-md-block" src={{hotel.img}} alt="Card image cap">
          <div class="card-body d-flex flex-column align-items-start">
          <h4>
            <a class="text-dark font-serif" id="hotel-{{hotel.index}}" href="#">#{{addone hotel.index}} {{hotel.name}}</a>
          </h4>
          <div class="mb-1 text-muted">{{hotel.price}}</div>
          <div class="rating">
            {{#ifEquals hotel.rating '5.0'}}
            <i class="fas fa-star"></i>
            <i class="fas fa-star"></i>
            <i class="fas fa-star"></i>
            <i class="fas fa-star"></i>
            <i class="fas fa-star"></i>
            {{/ifEquals}}
            {{#ifEquals hotel.rating '4.5'}}
            <i class="fas fa-star"></i>
            <i class="fas fa-star"></i>
            <i class="fas fa-star"></i>
            <i class="fas fa-star"></i>
            <i class="fas fa-star-half-alt"></i>
            {{/ifEquals}}
            {{#ifEquals hotel.rating '4.0'}}
            <i class="fas fa-star"></i>
            <i class="fas fa-star"></i>
            <i class="fas fa-star"></i>
            <i class="fas fa-star"></i>
            <i class="far fa-star"></i>
            {{/ifEquals}}
            {{#ifEquals hotel.rating '3.5'}}
            <i class="fas fa-star"></i>
            <i class="fas fa-star"></i>
            <i class="fas fa-star"></i>
            <i class="fas fa-star-half-alt"></i>
            <i class="far fa-star"></i>
            {{/ifEquals}}
            {{#ifEquals hotel.rating '3.0'}}
            <i class="fas fa-star"></i>
            <i class="fas fa-star"></i>
            <i class="fas fa-star"></i>
            <i class="far fa-star"></i>
            <i class="far fa-star"></i>
            {{/ifEquals}}
          </div>
          <p><i class="fas fa-user"></i> {{hotel.ratingNum}} </p>
          {{> reviewmodal hotel=hotel}}

          </div><!--card-body1 end-->


        </div><!--card1 end flex-md-row mb-4 box-shadow h-md-280-->
      </div><!--hotel1 end col-md-12-->
    </div><!--row mb-2 end-->
    {{/each}}<!--hotel card end-->
  </script>

  <script id="modal-template" type="text/x-handlebars-template">
    {{!-- Modal template, using partial --}}
    <!-- Button trigger modal -->
    <button type="button" class="btn btn-outline-primary btn-sm" data-toggle="modal" data-target="#modal-{{hotel.index}}">
      View user feedback
    </button>

    <!-- Modal -->
    <div class="modal fade bd-example-modal-lg" id="modal-{{hotel.index}}" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalCenterTitle">About Hotel #{{addone hotel.index}}</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>

          <div class="modal-body">
            <!-- <div class="btn-group btn-group-sm" id ="groupButton{{hotel.index}}" role="group" aria-label="Basic example"></div> -->
            
            <div id="modal-vis-{{hotel.index}}"></div>
            <div style="padding-left:30px; padding-top:20px;">
              <label class="switch" id="switchBox{{hotel.index}}" style="display:inline-block;">
                <input type="checkbox" onclick="filterOnOff({{hotel.index}})" checked>
                <div class="slider round"></div>
              </label> &nbsp;
              <h6 id="filterText{{hotel.index}}" style="display:inline-block;">Filtering is enabled</h6>
              <i class="fa fa-question-circle" data-toggle="tooltip" 
                title="You can filter reviews by clicking on elements of the chart"></i>
            </div>
            
              <div class="tab-pane fade active show" id="pills-reviews" role="tabpanel" aria-labelledby="pills-reviews-tab">
                <div class="bg-white rounded shadow-sm p-4 mb-4 restaurant-detailed-ratings-and-reviews">
                  
                  <h5 class="mb-1" style="display: inline-block;">All Reviews</h5> &nbsp;
                  <a href="#" class="text-muted" style="display: inline-block;" onclick="filterReviews({{hotel.index}}, {})">Show all</a>
                    <h6 id="filterResultTxt{{hotel.index}}" style="padding-bottom: 10px;" class="text-muted"></h6>
                    <div class="reviews-members pt-4 pb-4">
                      <!--replace block-->
                        <div id="modal-reviews-{{hotel.index}}">
                          {{> reviewlist reviews=hotel.reviews}}
                        </div>
                      <!--replace-->
                      <a href="#" class = "loading-hotel-{{hotel.index}}">Load More</a>
                    </div>               
                  </div>
                </div>
          </div><!--modal-body end-->
        <!-- </div> -->
          
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <!-- <button type="button" class="btn btn-primary">Save changes</button> -->
          </div>
        </div>
      </div>
    </div><!--model fade end-->
  </script>

<!--count index-->

<script>
  // compute hotel.index
  function countInd (){
    context.hotels.forEach((hotel, i) => {
      hotel.index = i;
    })
  }
  countInd ();
</script>
  
<!--reviews--> 
<script id="reviewlist-template" type="text/x-handlebars-template">
  {{#each reviews as |review|}}  
    <div class="media" id=review-{{hotel.index}}>
        <a><img alt="Avatar" src="user-img.png" class="mr-3 rounded-pill" 
        style="border-radius: 50rem; width: 56px;
          height: 56px;"></a>
        <div class="media-body">
          <div class="reviews-members-header">
            <h6 class="mb-1"><a class="text-primary">{{review.user_name}}</a></h6>
            <p class="mb-1 text-muted">{{review.user_wrote_time}}</p>
            <!-- <p class="mb-1 text-muted">Emotional polarity: {{review.polarity}}</p> -->
            <small>Contributions: {{review.contriNum}} &nbsp; &nbsp; &nbsp; Helpful number: {{review.helpfulNum}}</small> 
            <div class="rating">
              {{#ifEquals review.currentRating '5.0'}}
              <i class="fas fa-star"></i>
              <i class="fas fa-star"></i>
              <i class="fas fa-star"></i>
              <i class="fas fa-star"></i>
              <i class="fas fa-star"></i>
              {{/ifEquals}}
              {{#ifEquals review.currentRating '4.0'}}
              <i class="fas fa-star"></i>
              <i class="fas fa-star"></i>
              <i class="fas fa-star"></i>
              <i class="fas fa-star"></i>
              {{/ifEquals}}
              {{#ifEquals review.currentRating '3.0'}}
              <i class="fas fa-star"></i>
              <i class="fas fa-star"></i>
              <i class="fas fa-star"></i>
              {{/ifEquals}}
              {{#ifEquals review.currentRating '2.0'}}
              <i class="fas fa-star"></i>
              <i class="fas fa-star"></i>
              {{/ifEquals}}
              {{#ifEquals review.currentRating '1.0'}}
              <i class="fas fa-star"></i>
              {{/ifEquals}}
            </div>
            <div class = "review_content">
              <p class = "contents">{{review.content}}</p>
              <a href = "##" class = "readmore">Read More</a>
              <!-- <p>Keywords # 
              {{#each review.keywords as |word|}} 
                <span class="badge">{{word}}</span> 
              {{/each}}</p> -->
              <p>{{#each review.categories as |word|}} 
                <span class="badge bg-primary text-light">{{word}}</span> 
                {{/each}}</p>
            </div>
        </div>
      </div>
    </div>
  {{/each}}
</script>

<!--filter--> 
<script>
  
    var source = document.getElementById("reviewlist-template").innerHTML; //new list
    var reviewlistTemplate = Handlebars.compile(source);

    function filterReviews(hotelIndex, filterParams) {
      // console.log(hotelIndex, filterParams);
      var reviews = _.filter(context.hotels[hotelIndex].reviews, filterParams);
      console.log("filtered reviews: ", reviews);
      showNumFilter(hotelIndex, reviews.length);
      var rendered = reviewlistTemplate({reviews});
      // console.log(rendered); // Debug
      document.getElementById(`modal-reviews-${hotelIndex}`).innerHTML = rendered;
      loadSingleReview();
      // loadMoreReviews();
    }

    function filterCategory(hotelIndex, filterParams) {
      
      var reviews = _.filter(context.hotels[hotelIndex].reviews, function(x){
        var numContri = x.contriNum.split(" ")[0];
        var numHelpfulv = x.helpfulNum.split(" ")[0];
        var keywords = x.categories;
        // console.log(keywords);
        //Emo category
        if (filterParams == 'extremelyPositive'){
          return x.polarity >= 0.8;
        } else if (filterParams == 'positive') {
          return x.polarity > 0.2 && x.polarity < 0.8;
        } else if (filterParams == 'neutral') {
          return x.polarity >= -0.2 && x.polarity <= 0.2;
        } else if (filterParams == 'negative') {
          return x.polarity > -0.8 && x.polarity < -0.2;
        } else if (filterParams == 'extremelyNegative') {
          return x.polarity <= -0.8;
        } 
        //contribution
        else if (filterParams == 'newReviewer'){
          return numContri >= 1 && numContri <= 2;
        } else if (filterParams == 'juniorReviewer') {
          return numContri > 2 && numContri <= 10;
        } else if (filterParams == 'reviewer') {
          return numContri > 10 && numContri <= 20;
        } else if (filterParams == 'seniorReviewer') {
          return numContri > 20 && numContri <= 50;
        } else if (filterParams == 'proReviewer') {
          return numContri > 50 && numContri <= 100;
        } else if (filterParams == 'topReviewer') {
          return numContri > 100;
        }
        //helpful votes
        else if (filterParams == 'newContributor'){
          return numHelpfulv == 0;
        } else if (filterParams == 'juniorContributor') {
          return numHelpfulv >= 1 && numHelpfulv <= 10;
        } else if (filterParams == 'contributor') {
          return numHelpfulv > 10 && numHelpfulv <= 25;
        } else if (filterParams == 'seniorContributor') {
          return numHelpfulv > 25 && numHelpfulv <= 50;
        } else if (filterParams == 'proContributor') {
          return numHelpfulv > 50 && numHelpfulv <= 100;
        } else if (filterParams == 'topContributor') {
          return numHelpfulv > 100;
        }
        //keywords
        else {
          return keywords.includes(filterParams);
        }

      });
      // console.log("show reviews", reviews, reviews.length);
      showNumFilter(hotelIndex, reviews.length);

      var rendered = reviewlistTemplate({reviews});
      document.getElementById(`modal-reviews-${hotelIndex}`).innerHTML = rendered;
      loadSingleReview();
      // loadMoreReviews();
    }

    function filter2Criteria(hotelIndex, filterParams1, filterParams2) {
      var barId = parseFloat(filterParams2.split('pieId')[1]).toFixed(1);
      // console.log(filterParams1, barId.toString());
      var reviews = _.filter(context.hotels[hotelIndex].reviews, function(x){
        var numContri = x.contriNum.split(" ")[0];
        var numHelpfulv = x.helpfulNum.split(" ")[0];
        var keywords = x.categories;
        // console.log(x.currentRating, barId.toString());
        //Emo category
        if (filterParams1 == 'extremelyPositive'){
          return x.polarity >= 0.8 && x.currentRating == barId.toString();
        } else if (filterParams1 == 'positive') {
          return x.polarity > 0.2 && x.polarity < 0.8 && x.currentRating == barId.toString();
        } else if (filterParams1 == 'neutral') {
          return x.polarity >= -0.2 && x.polarity <= 0.2 && x.currentRating == barId.toString();
        } else if (filterParams1 == 'negative') {
          return x.polarity > -0.8 && x.polarity < -0.2 && x.currentRating == barId.toString();
        } else if (filterParams1 == 'extremelyNegative') {
          return x.polarity <= -0.8 && x.currentRating == barId.toString();
        } 
         //contribution
        else if (filterParams1 == 'newReviewer'){
          return numContri >= 1 && numContri <= 2 && x.currentRating == barId.toString();
        } else if (filterParams1 == 'juniorReviewer') {
          return numContri > 2 && numContri <= 10 && x.currentRating == barId.toString();
        } else if (filterParams1 == 'reviewer') {
          return numContri > 10 && numContri <= 20 && x.currentRating == barId.toString();
        } else if (filterParams1 == 'seniorReviewer') {
          return numContri > 20 && numContri <= 50 && x.currentRating == barId.toString();
        } else if (filterParams1 == 'proReviewer') {
          return numContri > 50 && numContri <= 100 && x.currentRating == barId.toString();
        } else if (filterParams1 == 'topReviewer') {
          return numContri > 100 && x.currentRating == barId.toString(); 
        }
        //helpful votes
        else if (filterParams1 == 'newContributor'){
          return numHelpfulv == 0 && x.currentRating == barId.toString();
        } else if (filterParams1 == 'juniorContributor') {
          return numHelpfulv >= 1 && numHelpfulv <= 10 && x.currentRating == barId.toString();
        } else if (filterParams1 == 'contributor') {
          return numHelpfulv > 10 && numHelpfulv <= 25 && x.currentRating == barId.toString();
        } else if (filterParams1 == 'seniorContributor') {
          return numHelpfulv > 25 && numHelpfulv <= 50 && x.currentRating == barId.toString(); 
        } else if (filterParams1 == 'proContributor') {
          return numHelpfulv > 50 && numHelpfulv <= 100 && x.currentRating == barId.toString();
        } else if (filterParams1 == 'topContributor') {
          return numHelpfulv > 100 && x.currentRating == barId.toString();
        }
        //keywords
        else {
          return keywords.includes(filterParams1) && x.currentRating == barId.toString();
        }
      });
      showNumFilter(hotelIndex, reviews.length);
      var rendered = reviewlistTemplate({reviews});
      document.getElementById(`modal-reviews-${hotelIndex}`).innerHTML = rendered;

      loadSingleReview();
      // loadMoreReviews();
    }

    function showNumFilter(index, num) {
      var txtDiv = document.getElementById('filterResultTxt'+ index);
      if (num > 1) {
        txtDiv.innerHTML = "( " + num + " reviews)";
      } else {
        txtDiv.innerHTML = "( " + num + " review)";
      }
      
    }

    function filterOnOff(index) {
      var curF = document.getElementById('filterText' + index);
      if (curF.innerHTML == "Filtering is enabled"){
        //close
        curF.innerHTML = "Filtering is disabled";
        d3.selectAll("rect").on('click',null);
        d3.selectAll(".arc").on('click',null);
        // $('.arc').prop('disabled',true);
        // $('rect').prop('disabled',true);
      } else {
        //open
        curF.innerHTML = "Filtering is enabled";
        d3.select("svg").remove();
        var legendRemove = $("#legend" + index);
        legendRemove.remove();
        var bg = $("#groupButton" + index);
        bg.remove();

        embedVis();
        groupClick();
      }


    }

</script>




<!--sort part-->
<script>
    var source = document.getElementById("hotellist-template").innerHTML;
    var hotellistTemplate = Handlebars.compile(source);

    // function shuffle(array) {
    //   var currentIndex = array.length, temporaryValue, randomIndex;

    //   // While there remain elements to shuffle...
    //   while (0 !== currentIndex) {

    //     // Pick a remaining element...
    //     randomIndex = Math.floor(Math.random() * currentIndex);
    //     currentIndex -= 1;

    //     // And swap it with the current element.
    //     temporaryValue = array[currentIndex];
    //     array[currentIndex] = array[randomIndex];
    //     array[randomIndex] = temporaryValue;
    //   }

    //   return array;
    // }
    function sortHotels(attrs, orders) {
      var attrList = [['name'], ['rating'], ['ratingNum'], ['price']];
      var orderList = [['desc'], ['asc']];
      var attrs = attrList[Math.floor(Math.random() * attrList.length)];
      var orders = orderList[Math.floor(Math.random() * orderList.length)];
      // console.log(attrs, orders);
      var sortedByName = _.orderBy(context.hotels, attrs, orders);
      // shuffle(context.hotels);
      // var sortedRandomly =  context.hotels;
      // console.log(sortedByName);
      var rendered = hotellistTemplate({hotels: sortedByName});
      document.getElementById(`body-hotel-list`).innerHTML = rendered;

      context.hotels.forEach((hotel, i) => {
        hotel.index = i;
      });
      embedVis();
      groupClick();
      loadSingleReview();
      loadMoreReviews();
    }
    
</script>

<!--handlebar-->
<script>
  // Funcations to modify content
  Handlebars.registerHelper('addone', value => value + 1);
  Handlebars.registerHelper('ifEquals', function(arg1, arg2, options){ //show user rating
    return (arg1 == arg2) ? options.fn(this):options.inverse(this);
  });
  Handlebars.registerHelper('isEqual', (value, equalTo) => value === equalTo);


  // Partials, like a component
  Handlebars.registerPartial('hotellist', document.getElementById("hotellist-template").innerHTML);
  Handlebars.registerPartial('reviewmodal', document.getElementById("modal-template").innerHTML);
  Handlebars.registerPartial('reviewlist', document.getElementById("reviewlist-template").innerHTML);
  // Code to render data into template
  var source = document.getElementById("entry-template").innerHTML;
  var template = Handlebars.compile(source);
  var rendered = template(context);
  //console.log(rendered); // Debug
  document.getElementById('handlebars-rendering-target').innerHTML = rendered;
</script>



<!--rank part-->
<script>
  function pickHotel(hotelIndex) {
    var hotel = _.find(context.hotels, {index: hotelIndex});
    hotel.checked = !hotel.checked;
  }
  
</script>

<script id="reorderinglist-template" type="text/x-handlebars-template">
  {{#if (isEqual items.length 3)}}
    <ul class="list-group" id="reorderingitems">
      {{#each items as |item|}}
        <li class="list-group-item">{{item.name}}</li>
      {{/each}}
    </ul>
  {{else}}
    You have picked {{items.length}} hotels. Please pick 3 hotels first.
  {{/if}}
</script>


<!-- vis script -->
<script> 
function dashboard(id, fData, index, linkdata){
    // console.log(fData[0]['freq']);
    var barColor = "#8d99ae";//'steelblue';
    function segColor(c){ 
      if (Object.keys(fData[0]['freq']).includes("negative")) {
        return {extremelyPositive:"#FA9601", positive:"#ffd100",neutral:"#c6dbef", 
        negative:"#6796C6", extremelyNegative:"#08519c"}[c]; 
      } 
      else if(Object.keys(fData[0]['freq']).includes("newReviewer")) {
        return {newReviewer:"#eff3ff", juniorReviewer:"#c6dbef",reviewer:"#9ecae1", 
          seniorReviewer:"#6baed6", proReviewer:"#3182bd", topReviewer:"#08519c"}[c]; 
        }
      else if(Object.keys(fData[0]['freq']).includes("newContributor")){
        return {newContributor:"#eff3ff", juniorContributor:"#c6dbef", contributor:"#9ecae1", 
          seniorContributor:"#6baed6", proContributor:"#3182bd", topContributor:"#08519c"}[c]; 
        }      
        else if(Object.keys(fData[0]['freq']).includes("food")){
        return {food:"#bdd002", facility:"#faa307", surroundings:"#ffd100", 
          service:"#7181b2", companion:"#8bb8e8", travelling_purpose:"#795ea5"}[c]; 
        }
      }
    
    //compute total for each state.
    //emo
    if (Object.keys(fData[0]['freq']).includes("negative")) {
      fData.forEach(function(d){
        d.total=d.freq.extremelyPositive+d.freq.positive+d.freq.neutral+d.freq.negative+d.freq.extremelyNegative;
      });
      // console.log("emo");
    } else if(Object.keys(fData[0]['freq']).includes("newReviewer")){
      //contri
      fData.forEach(function(d){
        d.total=d.freq.newReviewer+d.freq.juniorReviewer+d.freq.reviewer
          +d.freq.seniorReviewer+d.freq.proReviewer+d.freq.topReviewer;});
        // console.log("contri"); 
    } else if (Object.keys(fData[0]['freq']).includes("newContributor")){
      fData.forEach(function(d){
        d.total=d.freq.newContributor+d.freq.juniorContributor+d.freq.contributor
          +d.freq.seniorContributor+d.freq.proContributor+d.freq.topContributor;});
    } else if (Object.keys(fData[0]['freq']).includes("food")){
      fData.forEach(function(d){
        d.total=d.freq.food+d.freq.facility+d.freq.surroundings
          +d.freq.service+d.freq.companion+d.freq.travelling_purpose;});
    }
    
    // function to handle histogram.
    function histoGram(fD, nLdata, legendData){
      // console.log(nLdata);
      var hG={},    hGDim = {t: 40, r: 40, b: 0, l: 40};
      hGDim.w = 500 - hGDim.l - hGDim.r, 
      hGDim.h = 370 - hGDim.t - hGDim.b;
          
      //create svg for histogram.
      var barY = 2*hGDim.h/3 + 1;
      var hGsvg = d3.select(id).append("svg")
          .attr("width", hGDim.w + hGDim.l + hGDim.r)
          .attr("height", hGDim.h + hGDim.t).append("g")
          .attr("transform", "translate(" + hGDim.l + "," + hGDim.t + ")");

      // create function for x-axis mapping.
      var x = d3.scaleBand().range([0, hGDim.w]).padding(0.2)//rangeRound([0, hGDim.w], 2.0) //v3 d3.scale.ordinal().rangeRoundBands([0, hGDim.w], 0.1)
              .domain(fD.map(function(d) { return d[0]; }));
      // Create function for y-axis map.
      var y = d3.scaleLinear().range([barY, 0])// v3 d3.scale.linear().range([hGDim.h, 0])
              .domain([0, d3.max(fD, function(d) { return d[1]; })]);

      var tooltip = d3.select(id).append("div").attr("class", "toolTipBar");

      // Create bars for histogram to contain rectangles and freq labels.
      var bars = hGsvg.selectAll(".bar").data(fD).enter()
              .append("g").attr("class", "bar");
      //create the rectangles.
      bars.append("rect")
          .attr("x", function(d) { 
            return x(d[0]); 
          })
          .attr("y", function(d) { return y(d[1]); })
          .attr("width", x.bandwidth())//rangeBand())
          .attr("height", function(d) { 
            if (d[1] == 0){
              return 0;
            }
            else {return 2*hGDim.h/3 - y(d[1]); }
          })
          .attr('fill',barColor)
          .attr("id", function(d){
            return "barRect-" + d[0];
          })
          .on("mouseover", mouseover)
          .on('mousemove', mousemove)
          .on("mouseout", mouseout)
          .on("click", function(d) { 
            var filterObj = {};
            if (d[0] == "5"){
              var filterObj = {currentRating: "5.0"};
            } else if(d[0] == "4"){
              var filterObj = {currentRating: "4.0"};
            } else if(d[0] == "3"){
              var filterObj = {currentRating: "3.0"};
            } else if(d[0] == "2"){
              var filterObj = {currentRating: "2.0"};
            } else if(d[0] == "1"){
              var filterObj = {currentRating: "1.0"};
            }
            // d3.select(this).attr("stroke", "#883C44");
            // d3.select(this).attr("stroke-width", 2);
            // console.log(index);
            filterReviews(index, filterObj);
          });

      //Create the frequency labels above the rectangles.
      bars.append("text").text(function(d){ return d3.format(",")(d[1])})
          .attr("x", function(d) { return x(d[0])+x.bandwidth()/2; })
          .attr("y", function(d) { return y(d[1])-10; })
          .attr("text-anchor", "middle");

      //*****add sankey chart in this svg*******//
      var maxNodeY = Math.max(nLdata.links[0].value, nLdata.links[1].value,
        nLdata.links[2].value,nLdata.links[3].value,nLdata.links[4].value);

      var minNodeY = Math.min(nLdata.links[0].value, nLdata.links[1].value,
        nLdata.links[2].value,nLdata.links[3].value,nLdata.links[4].value);

      // console.log(minNodeY, maxNodeY);
      var pieSankey = hGsvg.append("g").attr("class", "sankeyPie")
          .attr("width", hGDim.w + hGDim.l + hGDim.r)
          .attr("height", hGDim.h/5)
          .attr("transform", "translate(" + 0 + "," + barY + ")");

      var sankey = d3.sankey()
        .nodeWidth(5) // node.dx = nodeWidth
        .nodePadding(80) 
        .size([hGDim.w, hGDim.h/5]);

      var sankeyPath = sankey.link();
      
      sankey
          .nodes(nLdata.nodes)
          .links(nLdata.links)
          .layout(32); // what is this? iterations

      var link = pieSankey.append("g").selectAll(".link").data(nLdata.links)
          .enter().append("path")
          .attr("class", "link");  
          
      var node = pieSankey.append("g").selectAll(".node")
          .data(nLdata.nodes)
        .enter().append("g")
          .attr("class", "node")
          .attr("transform", function(d, i) {
              // console.log(i);
              switch(i) {
                case 0: 
                case 5:{
                  d.x = x("5") + (x.bandwidth()-d.dy) / 2; 
                  break;
                }
                case 1: 
                case 6:{
                  d.x = x("4") + (x.bandwidth()-d.dy) / 2; 
                  break;
                }
                case 2: 
                case 7:{
                  d.x = x("3") + (x.bandwidth()-d.dy) / 2; 
                  break;
                }
                case 3: 
                case 8:{
                  d.x = x("2") + (x.bandwidth()-d.dy) / 2; 
                  break;
                }
                case 4: 
                case 9:{
                  d.x = x("1") + (x.bandwidth()-d.dy) / 2; 
                  break;
                }
              };
              return "translate(" + d.x + "," + d.y + ")"; 
          });
          // .call(d3.drag()
          // .on("drag", dragmove));

      //add rect as uppernode
      node.filter(function(d){
          return !d.pieData; //add rect
        }).append("rect")
          .attr("height", sankey.nodeWidth())
          .attr("width", function(d) { 
            // console.log(d.dy, x.bandwidth());
            return Math.min(d.dy, x.bandwidth()); })
          .style("fill", "#CDD0D3");


      //render link later for alignment 
      link.attr("d", sankeyPath)
        .style("stroke-width", function(d) { 
          return Math.min(d.dy, x.bandwidth()); 
        })
        .style("stroke", "#CDD0D3")
        .sort(function(a, b) { 
          return b.dy - a.dy; 
        });

    var outerRadius = 42,
        innerRadius = 0;

    var arc = d3.arc()
        .padRadius(outerRadius)
        // .outerRadius(outerRadius)
        .innerRadius(innerRadius);
    var pie = d3.pie()
          .sort(null)
          .value(function(d) { return d.value; });
    
    
    var g = node.filter(function(d){
        return d.pieData;
      })
    .append("g")
      .attr('transform', function(d,i){ // have been transformed by d.x d.y
        return 'translate('+d.dy/2+',' + 0 + ')';// just change d.x
      })
      .attr("class","pie")
      .attr("id", function(d){
        return "pieId" + d.pieId;
      })
      .selectAll(".arc")
      .data(function(d){return pie(d.pieData);})
      .enter()
    .append("path") 
      .attr("class", "arc")
      .attr("id", function(d){
        return "arc-" + d.data.type;
      }).each(function(d) { d.outerRadius = outerRadius - 5; })
      .attr("d", arc)
      .attr("fill",function(d,i){ 
          return segColor(d.data.type); 
        })
      .on("mouseover", arcTween(outerRadius, 0))
      .on("mouseout", arcTween(outerRadius - 5, 150))
      .on("click", function(d){
        var barId = $(this).parent().attr('id');
        filter2Criteria(index, d.data.type, barId);
      });

              
    // Add x-axis to the histogram svg.
    hGsvg.append("g").attr("class", "x axis")
          .style("font-size", "15px")
          .attr("transform", "translate(0," + 2*hGDim.h/3 + ")")
          .call(d3.axisBottom().tickSize(0).scale(x));
    // function dragmove(d) {
    //   //d3.select(this).attr("transform", "translate(" + d.x + "," + (d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))) + ")");
    //   d3.select(this).attr("transform", "translate(" + (d.x = Math.max(0, Math.min(hGDim.w - d.dy, d3.event.x))) + "," + d.y + ")");
    //   sankey.relayout();
    //   link.attr("d", sankeyPath);
    // }
    function arcTween(outerRadius, delay) {
      return function() {
        // console.log("change");
        d3.select(this).transition().delay(delay).attrTween("d", function(d) {
          var i = d3.interpolate(d.outerRadius, outerRadius);
          // console.log(d.outerRadius, outerRadius);
          return function(t) { d.outerRadius = i(t); return arc(d); };
        });
      };
    }

    function mouseover(d){  // utility function to be called on mouseover.
      //tooltip
      tooltip.style('display', 'inline');
      
      // grey pie
      var curPieId = parseInt(d[0]);
      // console.log("moveon", curPieId);
      for (i = 1; i < 6; i++)
      { if (i != curPieId){
          var tagDiv = $("#dashboard" + index).find(".sankeyPie");
          var pieDiv = tagDiv.find("#pieId" + i);
          pieDiv.find("path").css({fill: "#CDD0D3"});
          // $("#pieId" + i).find("path").css({fill: "#CDD0D3"});
        } else {
          continue;
      }}
      // filter for selected state.
      // var st = fData.filter(function(s){ return s.State == d[0];})[0],
      //     nD = d3.keys(st.freq).map(function(s){ return {type:s, freq:st.freq[s]};});
      // leg.update(nD);
    }

    function  mousemove(d) {
        var xPosition = d3.mouse(this)[0] + 50;//d3.event.pageX;
        var yPosition = d3.mouse(this)[1] + 5;    //d3.event.pageY;
        var st = fData.filter(function(s){ return s.State == d[0];})[0],
            nD = d3.keys(st.freq).map(function(s){ return {type:s, freq:st.freq[s]};});
        var perc = [];
        nD.forEach(function(t, ind){
          var temp = nD[ind].freq/d3.sum(nD.map(function(v){ return v.freq; }));
          perc[ind] = d3.format(".2%")(temp.toFixed(4));
        })

        var newHtml = [];
        newHtml.push('<table><h6>' + d[1] +'</h6>');
        // console.log("nD", nD);  
        nD.forEach(function(t, ind){
          // console.log(t);
          newHtml.push(
            '<tr>', 
            '<td id="key">' + nD[ind].type + '</td>',
            '<td id="value">' + nD[ind].freq + '</td>', 
            '<td id="value">' + perc[ind] + '</td>', 
            '</tr>')
        })
        newHtml.push('</table>');
        // console.log("mousemove", nD[0]);
        tooltip
          // .attr("transform", "translate(" + xPosition + "," + yPosition + ")")
          .style("left", xPosition  + "px")
          .style("top", yPosition + "px")
          .style("display", "inline-block")
          .html(newHtml.join("  "));
          // .html('Number:' + d[1] + "<br>"
          //     + "-----------" + "<br>"
          //     + nD[0].type + " " + nD[0].freq + " "+ outPerc0 + "<br>"
          //     + nD[1].type + " " + nD[1].freq + " "+ outPerc1+ "<br>"
          //     + nD[2].type + " " + nD[2].freq + " "+ outPerc2+ "<br>"
          //     + nD[3].type + " " + nD[3].freq + " "+ outPerc3+ "<br>"
          //     + nD[4].type + " " + nD[4].freq + " "+ outPerc4);
      
    }
    
    function mouseout(d){    // utility function to be called on mouseout.
        //tooltip
        tooltip.style('display', 'none');
        //remove grey
        var curPieId = parseInt(d[0]);
        // console.log("moveout", curPieId);
        for (i = 1; i < 6; i++){
          if (i != curPieId){
            var tagDiv = $("#dashboard" + index).find(".sankeyPie");
            var pieDiv = tagDiv.find("#pieId" + i);
            pieDiv.find("path").css({fill: ""});
            // $("#pieId" + i).find("path").css({fill: ""});
          }
        }
        
        // reset the pie-chart and legend.    
        // leg.update(tF);
    }
    
    // create function to update the bars. This will be used by pie-chart.
    hG.update = function(nD, color){
        // update the domain of the y-axis map to reflect change in frequencies.
        y.domain([0, d3.max(nD, function(d) { return d[1]; })]);
        
        // Attach the new data to the bars.
        var bars = hGsvg.selectAll(".bar").data(nD);
        // transition the height and color of rectangles.
        bars.select("rect").transition().duration(500)
            .attr("y", function(d) {return y(d[1]); })
            .attr("height", function(d) { return barY - y(d[1]); })
            .attr("fill", color);

        // transition the frequency labels location and change value.
        bars.select("text").transition().duration(500)
            .text(function(d){ return d3.format(",")(d[1])})
            .attr("y", function(d) {return y(d[1])-10; });            
    }        
        return hG;
    }


    // function to handle legend.
  function legend(lD, id){
    var leg = {}, legDim = {t: 0, r: 0, b: 0, l: 20};
    legDim.w = 300 - legDim.l - legDim.r, 
    legDim.h = 180 - legDim.t - legDim.b;
    // create table for legend.
    var legend = d3.select(id).append("table").attr('class','legend')
        .attr("width", legDim.w + legDim.l + legDim.r)
        .attr("height", legDim.h + legDim.t + legDim.b)
        .attr("transform", "translate(" + legDim.l + ",0");
    
    // create one row per segment.
    var tr = legend.append("tbody").selectAll("tr").data(lD).enter().append("tr");
        
    // create the first column for each segment.
    tr.append("td").append("svg").attr("width", '16').attr("height", '16').append("rect")
        .attr("width", '16').attr("height", '16')
        .attr("id", function(d){
            return "legendRect-" + d.type;
          })
        .attr("fill",function(d){ return segColor(d.type); })
        .on("mouseover", mouseover).on("mouseout",mouseout)
        .on("click", function(d) { 
            filterCategory(index, d.type);
            // d3.select(this).attr("stroke", "black");
            // d3.select(this).attr("stroke-width", 5);
          });
      
    // create the second column for each segment.
    tr.append("td").text(function(d){ return d.type;});

    // create the third column for each segment.
    // tr.append("td").attr("class",'legendFreq')
    //     .text(function(d){ return d3.format(",")(d.freq);});

    // // create the fourth column for each segment.
    // tr.append("td").attr("class",'legendPerc')
    //     .text(function(d){ 
    //       return getLegend(d,lD);
    //     });

    // Utility function to be used to update the legend.
    // leg.update = function(nD){
    //     // update the data attached to the row elements.
    //     var l = legend.select("tbody").selectAll("tr").data(nD);
        
    //     // update the frequencies.
    //     l.select(".legendFreq").text(function(d){ return d3.format(",")(d.freq);});

    //     // update the percentage column.
    //     l.select(".legendPerc").text(function(d){ return getLegend(d,nD);});        
    // }
    
    function getLegend(d,aD){ // Utility function to compute percentage.
        // return d3.format("%")(d.freq/d3.sum(aD.map(function(v){ return v.freq; })));
        var tempperc = d.freq/d3.sum(aD.map(function(v){ return v.freq; }));
        return d3.format(".2%")(tempperc.toFixed(4));
    }
    function mouseover(d){
        //grey all pies, focus on the bars
        // $('.arc').not('#arc-' + d.type).find("path").css({fill: "#CDD0D3"});
        $('.arc').not('#arc-' + d.type).css({fill: "#CDD0D3"});
        
        // call the update function of histogram with new data.
        var aspectsList = ['food', 'facility', 'surroundings', 'service', 'companion', 'travelling_purpose'];
        if (aspectsList.includes(d.type)) {
          hG.update(fData.map(function(v){ 
            return [v.State,v.freq2[d.type]];}),segColor(d.type));
        } else {
          hG.update(fData.map(function(v){ 
            return [v.State,v.freq[d.type]];}),segColor(d.type));
        }
        
    }
    //Utility function to be called on mouseout a pie slice.
    function mouseout(d){
        $('.arc').css({fill: ""});
        // call the update function of histogram with all data.
        hG.update(fData.map(function(v){
            return [v.State,v.total];}), barColor);
    }
      return leg;
    }

    // calculate total frequency by segment for all state.

    if (Object.keys(fData[0]['freq']).includes("negative")){
        var tF = ['extremelyPositive','positive','neutral','negative','extremelyNegative'].map(function(d){ 
          return {type:d, freq: d3.sum(fData.map(function(t){ return t.freq[d];}))}; 
        });  
    }
    else if (Object.keys(fData[0]['freq']).includes("reviewer")) {
        var tF = ['newReviewer','juniorReviewer', 'reviewer','seniorReviewer',
        'proReviewer', 'topReviewer'].map(function(d){ 
              return {type:d, freq: d3.sum(fData.map(function(t){ return t.freq[d];}))}; 
        });    
    } else if (Object.keys(fData[0]['freq']).includes("contributor")) {
        var tF = ['newContributor', 'juniorContributor', 'contributor','seniorContributor',
        'proContributor', 'topContributor'].map(function(d){ 
              return {type:d, freq: d3.sum(fData.map(function(t){ return t.freq[d];}))}; 
        });    
    } else if (Object.keys(fData[0]['freq']).includes("food")) {
        var tF = ['food', 'facility', 'surroundings','service','companion', 
          'travelling_purpose'].map(function(d){ 
              return {type:d, freq: d3.sum(fData.map(function(t){ return t.freq[d];}))}; 
        });    
    }
      
    
    // calculate total frequency by state for all segment.
    var sF = fData.map(function(d){return [d.State,d.total];});

    var st5 = fData.filter(function(s){ return s.State;})[0],
          nD5 = d3.keys(st5.freq).map(function(s){ return {type:s, freq:st5.freq[s]};});
    var st4 = fData.filter(function(s){ return s.State;})[1],
          nD4 = d3.keys(st4.freq).map(function(s){ return {type:s, freq:st4.freq[s]};})
    var st3 = fData.filter(function(s){ return s.State;})[2],
          nD3 = d3.keys(st3.freq).map(function(s){ return {type:s, freq:st3.freq[s]};})
    var st2 = fData.filter(function(s){ return s.State;})[3],
          nD2 = d3.keys(st2.freq).map(function(s){ return {type:s, freq:st2.freq[s]};})
    var st1 = fData.filter(function(s){ return s.State;})[4],
          nD1 = d3.keys(st1.freq).map(function(s){ return {type:s, freq:st1.freq[s]};})
    //console.log("all data:", fData);

    var linkDataEmo = {
    "nodes": [{
      "node": 0,
      "name": "1"
    },  {
      "node": 1,
      "name": "2"
    }, {
      "node": 2,
      "name": "3"
    }, {
      "node": 3,
      "name": "4"
    }, {
      "node": 4,
      "name": "5"
    },{
      "node": 5,
      "name": "6",
      "pieId": 5,
      "pieData": [{
        "value": Math.random()
      },{
        "value": Math.random()
      },{
        "value": Math.random()
      },{
        "value": Math.random()
      },{
        "value": Math.random()
      }]
    },{
      "node": 6,
      "name": "7",
      "pieId": 4,
      "pieData": [{
        "value": Math.random()
      },{
        "value": Math.random()
      },{
        "value": Math.random()
      },{
        "value": Math.random()
      },{
        "value": Math.random()
      }]
    },
    {
      "node": 7,
      "name": "8",
      "pieId": 3,
      "pieData": [{
        "value": Math.random()
      },{
        "value": Math.random()
      },{
        "value": Math.random()
      },{
        "value": Math.random()
      },{
        "value": Math.random()
      }]
    },
    {
      "node": 8,
      "name": "9",
      "pieId": 2,
      "pieData": [{
        "value": Math.random()
      },{
        "value": Math.random()
      },{
        "value": Math.random()
      },{
        "value": Math.random()
      },{
        "value": Math.random()
      }]
    }, {
      "node": 9,
      "name": "10",
      "pieId": 1,
      "pieData": [{
        "value": Math.random()
      },{
        "value": Math.random()
      },{
        "value": Math.random()
      },{
        "value": Math.random()
      },{
        "value": Math.random()
      }]
    }
    ], //all nodes
    "links": [{
      "source": 0,
      "target": 5,
      "value": 64
    }, {
      "source": 1,
      "target": 6,
      "value": 54  //node.dy = node.value * ky, ky~nodePadding & value
    },
    {
      "source": 2,
      "target": 7,
      "value": 15 
    }, {
      "source": 3,
      "target": 8,
      "value": 1 
    },
    {
      "source": 4,
      "target": 9,
      "value": 7  
    }]// all links
    }    
    // console.log(linkNum1);
    linkDataEmo.links.map((link, index, arr) => {
      ind = (index+1).toString()
      if (ind == "5") ind2 = "1"
      if (ind == "4") ind2 = "2"
      if (ind == "3") ind2 = "3"
      if (ind == "2") ind2 = "4"
      if (ind == "1") ind2 = "5"
      // console.log(link.value, ind2);
      link.value = linkdata[ind2];
    })

    // read link data from fData
    Object.size = function(obj) {
      var size = 0,
        key;
      for (key in obj) {
        if (obj.hasOwnProperty(key)) size++;
      }
      return size;
    };

    if (Object.size(fData[0]['freq']) == 5){
      // add link value
      linkDataEmo.nodes.map((item, index, arr)=>{
        // console.log(item.name);
        if (item.hasOwnProperty("pieData")) { 
          item.pieData.map((itemPie, indPie, arrPie) => {            
            itemPie.value = fData[index-5]['freq'][Object.keys(fData[index-5]['freq'])[indPie]];
            itemPie.type = Object.keys(fData[index-5]['freq'])[indPie];
            });
          }
      })
    }

    
    else if (Object.size(fData[0]['freq']) == 6) {
      linkDataEmo.nodes.map((item, index, arr)=>{
        if (item.hasOwnProperty("pieData")) { 
          item['pieData'].push({"value": Math.random()});
        }
      })
      linkDataEmo.nodes.map((item, index, arr)=>{
      //   // console.log(item.name);
        if (item.hasOwnProperty("pieData")) { 
          item.pieData.map((itemPie, indPie, arrPie) => {   
            // console.log(fData[index-5]['freq'], Object.keys(fData[index-5]['freq'])[indPie]);
            itemPie.value = fData[index-5]['freq'][Object.keys(fData[index-5]['freq'])[indPie]];
            itemPie.type = Object.keys(fData[index-5]['freq'])[indPie];
          });
        }
      })
    }

    //sankeyPie(linkDataEmo);
    var hG = histoGram(sF, linkDataEmo, tF), // create the histogram.
        leg= legend(tF, '#legend' + index);  // create the legend.

}

</script>

<!--switch group-->
<script type="text/javascript">
  // code to run after the elements are created
function embedVis() {
  context.hotels.forEach(hotel => {
    // var visHTML = '<div id="modal-vis-" '+ hotel.index +' >';
    var visDiv = document.getElementById("modal-vis-" + hotel.index);
    visDiv.className = 'row';
    
    var dashboardDiv = document.createElement('div');
    dashboardDiv.id = 'dashboard' + hotel.index;
    
    var legendDiv = document.createElement('div');
    legendDiv.id = 'legend' + hotel.index;
    
    // var buttonDiv = document.getElementById("modal-button-" + hotel.index);
    // buttonDiv.class = 'row';
    
    var buttonGroup = document.createElement('div');
    buttonGroup.classList.add("btn-group", "btn-group-sm");
    buttonGroup.id = "groupButton" + hotel.index;
    buttonGroup.setAttribute("role", "group");
    buttonGroup.setAttribute("aria-label", "Basic example");
    // var buttonGroup = document.getElementById('groupButton' + hotel.index);
    buttonGroup.style.paddingLeft = '30px';
    buttonGroup.style.paddingRight = '30px';
    
    // var checkBox = document.getElementsByClassName('checkBox' + hotel.index);
    // checkBox.style.height = '8px';
    // checkBox.style.width = '12px';
    
    var buttonEmo = document.createElement('button');
    buttonEmo.classList.add("btn", "btn-outline-primary", "active");
    buttonEmo.id = 'buttonEmo' + hotel.index;
    buttonEmo.innerHTML = 'Emotion';
    var buttonContri = document.createElement('button');
    buttonContri.classList.add("btn", "btn-outline-primary");
    buttonContri.id = 'buttonContri' + hotel.index;
    buttonContri.innerHTML = 'Contribution';
    var buttonHelpfulv = document.createElement('button');
    buttonHelpfulv.classList.add("btn", "btn-outline-primary");
    buttonHelpfulv.id = 'buttonHelpfulv' + hotel.index;
    buttonHelpfulv.innerHTML = 'Helpful votes';
    var buttonKeywords = document.createElement('button');
    buttonKeywords.classList.add("btn", "btn-outline-primary");
    buttonKeywords.id = 'buttonKeywords' + hotel.index;
    buttonKeywords.innerHTML = 'Aspects';
    
    buttonGroup.appendChild(buttonEmo);
    buttonGroup.appendChild(buttonContri);
    buttonGroup.appendChild(buttonHelpfulv);
    buttonGroup.appendChild(buttonKeywords);
    
    
    visDiv.appendChild(dashboardDiv);
    visDiv.appendChild(legendDiv);
    visDiv.appendChild(buttonGroup);
    // buttonDiv.appendChild(filterBox);
    visDiv.insertAdjacentElement('beforebegin', buttonGroup);
    
    var hotelCategoryData = JSON.parse(JSON.stringify(hotelEmoAll[hotel.index]));
    
    //switch function

    dashboard('#dashboard'+ hotel.index, hotelCategoryData, hotel.index, linkNumAll[hotel.index]);

  })
}

embedVis();
</script>
<script>
  function groupClick() {
    $(".btn-group > .btn").click(function(){
          $(".btn-group > .btn").removeClass("active");
          $(this).addClass("active");
          // console.log(this.id);
          
          if (this.id.includes('Contri')) {
            // console.log("switch contri");
            var curInd = this.id.replace('buttonContri', '');
            var contriLoad = JSON.parse(JSON.stringify(hotelContriAll[curInd]));
            var removeLegend = document.getElementById('legend' + curInd);
            removeLegend.innerHTML = '';
            var removeBar = document.getElementById('dashboard' + curInd);
            removeBar.innerHTML = '';

            dashboard('#dashboard'+ curInd, contriLoad, curInd, linkNumAll[curInd]);
            
          } 
          else if (this.id.includes('Emo')) {
            // console.log("switch emo");
            var curInd = this.id.replace('buttonEmo', '');
            var emoLoad = JSON.parse(JSON.stringify(hotelEmoAll[curInd]));
            var removeLegend = document.getElementById('legend' + curInd);
            removeLegend.innerHTML = '';
            var removeBar = document.getElementById('dashboard' + curInd);
            removeBar.innerHTML = '';

            dashboard('#dashboard'+ curInd, emoLoad, curInd, linkNumAll[curInd]);
          }
          else if (this.id.includes('Helpfulv')) {
            // console.log("switch Helpfulv");
            var curInd = this.id.replace('buttonHelpfulv', '');
            var helpfulvLoad = JSON.parse(JSON.stringify(hotelHelpfulAll[curInd]));
            var removeLegend = document.getElementById('legend' + curInd);
            removeLegend.innerHTML = '';
            var removeBar = document.getElementById('dashboard' + curInd);
            removeBar.innerHTML = '';

            dashboard('#dashboard'+ curInd, helpfulvLoad, curInd, linkNumAll[curInd]);
          }
          else if (this.id.includes('Keywords')) {
            // console.log("switch aspects");
            var curInd = this.id.replace('buttonKeywords', '');
            var keywordsLoad = JSON.parse(JSON.stringify(hotelWordsAll[curInd]));
            var removeLegend = document.getElementById('legend' + curInd);
            removeLegend.innerHTML = '';
            var removeBar = document.getElementById('dashboard' + curInd);
            removeBar.innerHTML = '';

            dashboard('#dashboard'+ curInd, keywordsLoad, curInd, linkNumAll[curInd]);
          }
      });
    }
    groupClick();
</script>


<!--load reviews-->
<script type="text/javascript">
  // read more contents from each review
  function loadSingleReview(){
      $('.review_content').each(function(index,element){
        var maxwidth=300;//设置最多显示的字数
        var text_long=$(this).find("p[class = 'contents']").text();
        var text_short = text_long.substring(0,maxwidth);
        if(text_long.length>maxwidth){
            $(this).find("p[class = 'contents']").html(text_short+"...");
        };
        var read_button = $(this).find('a');
        read_button.click(function(){
            if(read_button.text()==="Read More"){
              read_button.parent().find("p[class = 'contents']").html(text_long);
              read_button.text("Read Less");
            } else if (read_button.text()==="Read Less"){
              read_button.parent().find("p[class = 'contents']").html(text_short+"...");
              read_button.text("Read More");
            }
        })
      })
  }
  
// load 5 more reviews each click
  function loadMoreReviews() {
    $('.reviews-members').each(function(index,element){
      var count = 5;
      var read_more = $(this).find("a[class^='loading-hotel']");
      var all_reviews = $(this).find("div[class ='media']");
      all_reviews.each(function(index,element){
        $(this).css({"display":'none'});
      }); 

      all_reviews.slice(0,3).show();
      read_more.click(function(){
        count += 5;
        all_reviews.slice(0,count).show();
      })
    })
  }
  loadSingleReview();
  loadMoreReviews();
  </script>

<script>//data to backend
    parseAPI.init()
    function recordResult() {
      parseAPI.saveResult(
        {username: 'hello', q1: true, q2: false}, 
        {anything: 'you wanna add', numbers: 123, but: {better: 'not object'}} //not obj
      ) 
    }
  </script>


<!--rank 2-->
<script>
  var source = document.getElementById("reorderinglist-template").innerHTML;
  var reorderinglistTemplate = Handlebars.compile(source);
  
  $('#modal-picktop').on('shown.bs.modal', function (e) {
      var topHotels = _.filter(context.hotels, {checked: true});
      var rendered = reorderinglistTemplate({items: topHotels});
      // console.log(rendered);
      document.getElementById('picktop-modal-body').innerHTML = rendered;
      if (topHotels.length === 3) {
        var reorderingitems = document.getElementById('reorderingitems');
        Sortable.create(reorderingitems, { animation: 100, group: 'list-1', draggable: '.list-group-item', handle: '.list-group-item', sort: true, filter: '.sortable-disabled', chosenClass: 'active' });
        $('#modal-picktop-save').prop('disabled', false);
      } else {
        $('#modal-picktop-save').prop('disabled', true);
      }
  });

  function recordOrder() {
    var items = $('#reorderingitems li').map(function(){return $(this).text()}).get();
    console.log(items);
  }
</script>
<script>
  $(document).ready(function(){
    $('[data-toggle="tooltip"]').tooltip();   
  });

  $(function () {
        $("[data-toggle='tooltip']").tooltip();
    });
</script>
</body>

</html>